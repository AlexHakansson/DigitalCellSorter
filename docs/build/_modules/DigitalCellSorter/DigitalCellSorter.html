

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>DigitalCellSorter.DigitalCellSorter &mdash; DigitalCellSorter 1.2.2 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> DigitalCellSorter
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html"><strong>Digital Cell Sorter</strong></a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">DigitalCellSorter</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>DigitalCellSorter.DigitalCellSorter</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for DigitalCellSorter.DigitalCellSorter</h1><div class="highlight"><pre>
<span></span><span class="sd">&#39;&#39;&#39;The main class for cell sorting functions and producing output images is DigitalCellSorter. The class includes tools for:</span>

<span class="sd">  1. **Pre-preprocessing** of single cell mRNA sequencing data (gene expression data)</span>
<span class="sd">       1. Cleaning: filling in missing values, zemoving all-zero genes and cells, converting gene index to a desired convention, etc.</span>
<span class="sd">       2. Normalizing: rescaling all cells expression, log-transforming, etc.</span>

<span class="sd">  2. **Quality control**</span>

<span class="sd">  3. **Batch effects correction**</span>

<span class="sd">  4. **Cells anomaly score evaluation**</span>

<span class="sd">  5. **Dimensionality reduction**</span>

<span class="sd">  6. **Clustering** (Hierarchical, K-Means, knn-graph-based, etc.)</span>

<span class="sd">  7. **Annotating cell types**</span>

<span class="sd">  8. **Vizualization**</span>
<span class="sd">       1. t-SNE layout plot</span>
<span class="sd">       2. Quality Control histogram plot</span>
<span class="sd">       3. Marker expression t-SNE subplot</span>
<span class="sd">       4. Marker-centroids expression plot</span>
<span class="sd">       5. Voting results matrix plot</span>
<span class="sd">       6. Cell types stacked barplot</span>
<span class="sd">       7. Anomaly scores plot</span>
<span class="sd">       8. Histogram null distribution plot</span>
<span class="sd">       9. New markers plot</span>
<span class="sd">       10. Sankey diagram (a.k.a. river plot)</span>
<span class="sd">  </span>
<span class="sd">  9. **Post-processing** functions, e.g. extract cells of interest, find significantly expressed genes, </span>
<span class="sd">  plot marker expression of the cells of interest, etc.</span>
<span class="sd">&#39;&#39;&#39;</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">platform</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">multiprocessing</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="kn">import</span> <span class="nn">scipy.stats</span>
<span class="kn">import</span> <span class="nn">scipy.signal</span>
<span class="kn">import</span> <span class="nn">scipy.cluster.hierarchy</span>
<span class="kn">import</span> <span class="nn">scipy.spatial.distance</span>
<span class="kn">from</span> <span class="nn">scipy.interpolate</span> <span class="k">import</span> <span class="n">UnivariateSpline</span>

<span class="kn">import</span> <span class="nn">matplotlib</span>
<span class="n">matplotlib</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;Agg&#39;</span><span class="p">)</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">matplotlib.patheffects</span> <span class="k">as</span> <span class="nn">path_effects</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="k">import</span> <span class="n">cm</span>

<span class="kn">import</span> <span class="nn">sklearn.metrics</span>
<span class="kn">import</span> <span class="nn">sklearn.cluster</span>
<span class="kn">from</span> <span class="nn">sklearn.decomposition</span> <span class="k">import</span> <span class="n">PCA</span>
<span class="kn">from</span> <span class="nn">sklearn.manifold</span> <span class="k">import</span> <span class="n">TSNE</span>
<span class="kn">from</span> <span class="nn">sklearn.cluster</span> <span class="k">import</span> <span class="n">AgglomerativeClustering</span><span class="p">,</span> <span class="n">KMeans</span>
<span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="k">import</span> <span class="n">IsolationForest</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">GeneNameConverter</span><span class="p">,</span> <span class="n">geneLists</span>
<span class="kn">from</span> <span class="nn">.Combat</span> <span class="k">import</span> <span class="n">combat</span>
<span class="kn">from</span> <span class="nn">.VisualizationFunctions</span> <span class="k">import</span> <span class="n">VisualizationFunctions</span>
<span class="kn">from</span> <span class="nn">.GenericFunctions</span> <span class="k">import</span> <span class="o">*</span>

<div class="viewcode-block" id="DigitalCellSorter"><a class="viewcode-back" href="../../DigitalCellSorterClass.html#DigitalCellSorter.DigitalCellSorter.DigitalCellSorter">[docs]</a><span class="k">class</span> <span class="nc">DigitalCellSorter</span><span class="p">(</span><span class="n">VisualizationFunctions</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;Class of Digital Cell Sorter with methods for processing single cell mRNA-seq data.</span>
<span class="sd">    Includes analyses and visualization tools.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        dataName: str, Default &#39;dataName&#39;</span>
<span class="sd">            Name used in output files</span>

<span class="sd">        geneListFileName: str, Default None</span>
<span class="sd">            Name of the marker genes file</span>

<span class="sd">        mitochondrialGenes: list, Default None</span>
<span class="sd">            List of mitochondrial genes to use in quality control</span>

<span class="sd">        sigmaOverMeanSigma: float, Default 0.3</span>
<span class="sd">            Threshold to consider a gene constant</span>

<span class="sd">        nClusters: </span>
<span class="sd">            Number of clusters, Default 5</span>

<span class="sd">        clusteringFunction: function, Default AgglomerativeClustering</span>
<span class="sd">            Clustering function to use.</span>
<span class="sd">            Other options: KMeans, {k_neighbors:40}, etc.</span>

<span class="sd">        nComponentsPCA: int, Default 100</span>
<span class="sd">            Number of pca components</span>

<span class="sd">        nSamplesDistribution: int, Default 10000</span>
<span class="sd">            Number of random samples in distribution</span>

<span class="sd">        saveDir: str, Default os.path.join(&#39;&#39;)</span>
<span class="sd">            Directory for output files</span>

<span class="sd">        makeMarkerSubplots: boolean, Default True</span>
<span class="sd">            Whether to make subplots on markers</span>

<span class="sd">        makePlots: boolean, Default True</span>
<span class="sd">            Whether to make all major plots</span>

<span class="sd">        votingScheme: function, Default None</span>
<span class="sd">            Voting shceme to use instead of the built-in</span>

<span class="sd">        availableCPUsCount: int, Default os.cpu_count()</span>
<span class="sd">            Number of CPUs available</span>

<span class="sd">        zScoreCutoff: float, Default 0.3</span>
<span class="sd">            Z-Score cutoff when calculating Z_mc</span>

<span class="sd">        minimumScoreForUnknown: float, Default 0.3</span>
<span class="sd">            Z-Score cutoff when assigning label &quot;Unknown&quot;</span>

<span class="sd">        clusterName: str, Default None</span>
<span class="sd">            Parameter used in subclustering</span>

<span class="sd">        doQualityControl: boolean, Default True</span>
<span class="sd">            Whether to remove low quality cells</span>

<span class="sd">        doBatchCorrection: boolean, Default False</span>
<span class="sd">            Whether to correct data for batches</span>
<span class="sd">    </span>
<span class="sd">    Usage:</span>
<span class="sd">        DCS = DigitalCellSorter.DigitalCellSorter()</span>

<span class="sd">        df_data = DCS.Clean(df_data)</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">gnc</span> <span class="o">=</span> <span class="n">GeneNameConverter</span><span class="o">.</span><span class="n">GeneNameConverter</span><span class="p">(</span><span class="n">dictDir</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;DigitalCellSorter&#39;</span><span class="p">,</span> <span class="s1">&#39;pickledGeneConverterDict&#39;</span><span class="p">,</span> <span class="s1">&#39;ensembl_hugo_entrez_alias_dict.pythdat&#39;</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataName</span><span class="o">=</span><span class="s1">&#39;dataName&#39;</span><span class="p">,</span> <span class="n">geneListFileName</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mitochondrialGenes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">sigmaOverMeanSigma</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">nClusters</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">clusteringFunction</span><span class="o">=</span><span class="n">AgglomerativeClustering</span><span class="p">,</span> <span class="n">nComponentsPCA</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">nSamplesDistribution</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span> 
                <span class="n">saveDir</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">),</span> <span class="n">makeMarkerSubplots</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">availableCPUsCount</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">(),</span> <span class="n">zScoreCutoff</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span>
                <span class="n">subclusteringName</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">doQualityControl</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">doBatchCorrection</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">makePlots</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">minimumNumberOfMarkersPerCelltype</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">minimumScoreForUnknown</span><span class="o">=</span><span class="mf">0.3</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Initialization function. Automatically called when an instance on Digital Cell Sorter is created&#39;&#39;&#39;</span>

        <span class="n">defaultGeneList</span> <span class="o">=</span> <span class="s1">&#39;CIBERSORT&#39;</span> <span class="c1"># &#39;CIBERSORT&#39; &#39;markersDCS&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">saveDir</span> <span class="o">=</span> <span class="n">saveDir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataName</span> <span class="o">=</span> <span class="n">dataName</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">defualtGeneListsDir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">geneLists</span><span class="o">.</span><span class="vm">__file__</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">geneListFileName</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">defualtGeneListsDir</span><span class="p">,</span> <span class="n">defaultGeneList</span> <span class="o">+</span> <span class="s1">&#39;.xlsx&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">geneListFileName</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">geneListFileName</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">mitochondrialGenes</span> <span class="o">=</span> <span class="n">mitochondrialGenes</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">sigmaOverMeanSigma</span> <span class="o">=</span> <span class="n">sigmaOverMeanSigma</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nClusters</span> <span class="o">=</span> <span class="n">nClusters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nComponentsPCA</span> <span class="o">=</span> <span class="n">nComponentsPCA</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zScoreCutoff</span> <span class="o">=</span> <span class="n">zScoreCutoff</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">minimumNumberOfMarkersPerCelltype</span> <span class="o">=</span> <span class="n">minimumNumberOfMarkersPerCelltype</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">minimumScoreForUnknown</span> <span class="o">=</span> <span class="n">minimumScoreForUnknown</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">nSamplesDistribution</span> <span class="o">=</span> <span class="n">nSamplesDistribution</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">availableCPUsCount</span> <span class="o">=</span> <span class="n">availableCPUsCount</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">clusteringFunction</span> <span class="o">=</span> <span class="n">clusteringFunction</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">subclusteringName</span> <span class="o">=</span> <span class="n">subclusteringName</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">toggleRecordAllExpression</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">toggleDoQualityControl</span>  <span class="o">=</span>  <span class="n">doQualityControl</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">toggleDoBatchCorrection</span> <span class="o">=</span> <span class="n">doBatchCorrection</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">toggleMakeHistogramNullDistributionPlot</span> <span class="o">=</span> <span class="n">makePlots</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">toggleMakeVotingResultsMatrixPlot</span> <span class="o">=</span> <span class="n">makePlots</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">toggleMakeMarkerExpressionPlot</span> <span class="o">=</span> <span class="n">makePlots</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">toggleMakeTSNEplotQC</span> <span class="o">=</span> <span class="n">makePlots</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">toggleMakeTSNEplotClusters</span> <span class="o">=</span> <span class="n">makePlots</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">toggleMakeTSNEplotAnnotatedClusters</span> <span class="o">=</span> <span class="n">makePlots</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">toggleMakeTSNEplotBatches</span> <span class="o">=</span> <span class="n">makePlots</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">toggleMakeStackedBarplot</span> <span class="o">=</span> <span class="n">makePlots</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">toggleAnomalyScoresTSNEplot</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">toggleMakeMarkerSubplots</span> <span class="o">=</span> <span class="n">makeMarkerSubplots</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="k">return</span> <span class="kc">None</span>

    <span class="c1"># Main functions of class #################################################################################################################################</span>
<div class="viewcode-block" id="DigitalCellSorter.prepare"><a class="viewcode-back" href="../../DigitalCellSorterClass.html#DigitalCellSorter.DigitalCellSorter.DigitalCellSorter.prepare">[docs]</a>    <span class="k">def</span> <span class="nf">prepare</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Prepare pandas.DataFrame for input to function process()</span>
<span class="sd">        If input is pd.DataFrame validate the input whether it has correct structure.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            obj: str, pandas.DataFrame, pandas.Series</span>
<span class="sd">                Expression data in a form of pandas.DataFrame, pandas.Series, or name and path to a csv file with data</span>

<span class="sd">        Returns:</span>
<span class="sd">            pandas.DataFrame</span>
<span class="sd">                Pandas DataFrame</span>
<span class="sd">        </span>
<span class="sd">        Usage:</span>
<span class="sd">            DCS = DigitalCellSorter.DigitalCellSorter()</span>

<span class="sd">            df_expr = DCS.preapre(&#39;data.csv&#39;)</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="ow">is</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Received data in a form of pandas.Series&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Validating it and converting it to pandas.DataFrame&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="s1">&#39;cell&#39;</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">names</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Column &quot;cell&quot; not found. Returning None&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="s1">&#39;gene&#39;</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">names</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Column &quot;gene&quot; not found. Returning None&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="s1">&#39;batch&#39;</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">names</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Column &quot;batch&quot; not found. Assuming one batch in the data.&#39;</span><span class="p">)</span>
                <span class="n">batch</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="s1">&#39;batch0&#39;</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="s1">&#39;cell&#39;</span><span class="p">)))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">batch</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="s1">&#39;batch&#39;</span><span class="p">)</span>

            <span class="n">obj</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="o">.</span><span class="n">from_arrays</span><span class="p">([</span><span class="n">batch</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="s1">&#39;cell&#39;</span><span class="p">),</span> <span class="n">obj</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="s1">&#39;gene&#39;</span><span class="p">)],</span> <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;batch&#39;</span><span class="p">,</span> <span class="s1">&#39;cell&#39;</span><span class="p">,</span> <span class="s1">&#39;gene&#39;</span><span class="p">])</span>

            <span class="n">obj</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">unstack</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="s1">&#39;gene&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>

            <span class="k">return</span> <span class="n">obj</span>

        <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="ow">is</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Received data in a form of pandas.DataFrame&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Validating pandas.DataFrame&#39;</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">obj</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;gene&#39;</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;DataFrame index format is not understood. Returning None&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="s1">&#39;cell&#39;</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">names</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Columns level &quot;cell&quot; not found. Returning None&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="s1">&#39;batch&#39;</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">names</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Columns level &quot;batch&quot; not found. Assuming one batch in the data.&#39;</span><span class="p">)</span>
                <span class="n">batch</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="s1">&#39;batch0&#39;</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="s1">&#39;cell&#39;</span><span class="p">)))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">batch</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="s1">&#39;batch&#39;</span><span class="p">)</span>

            <span class="n">obj</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="o">.</span><span class="n">from_arrays</span><span class="p">([</span><span class="n">batch</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="s1">&#39;cell&#39;</span><span class="p">)],</span> <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;batch&#39;</span><span class="p">,</span> <span class="s1">&#39;cell&#39;</span><span class="p">])</span>

            <span class="k">return</span> <span class="n">obj</span>

        <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
            <span class="n">columns</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nrows</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

            <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;cell&#39;</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;gene&#39;</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;expr&#39;</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Received data in a form of condensed matrix. Reading data&#39;</span><span class="p">)</span>
                <span class="n">df_expr</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Converting it to pandas.DataFrame&#39;</span><span class="p">)</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="s1">&#39;cell&#39;</span> <span class="ow">in</span> <span class="n">df_expr</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;The column with &quot;cell&quot; identifiers is not found. Returning None&#39;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="kc">None</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="s1">&#39;gene&#39;</span> <span class="ow">in</span> <span class="n">df_expr</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;The column with &quot;gene&quot; identifiers is not found. Returning None&#39;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="kc">None</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="s1">&#39;expr&#39;</span> <span class="ow">in</span> <span class="n">df_expr</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;The column with expression values is not found. Returning None&#39;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="kc">None</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="s1">&#39;batch&#39;</span> <span class="ow">in</span> <span class="n">df_expr</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;The column with &quot;batch&quot; identifiers is not found. Assuming one batch in the data&#39;</span><span class="p">)</span>
                    <span class="n">df_expr</span><span class="p">[</span><span class="s1">&#39;batch&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="s1">&#39;batch0&#39;</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">df_expr</span><span class="p">))</span>

                <span class="n">df_expr</span> <span class="o">=</span> <span class="n">df_expr</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s1">&#39;batch&#39;</span><span class="p">,</span> <span class="s1">&#39;cell&#39;</span><span class="p">,</span> <span class="s1">&#39;gene&#39;</span><span class="p">])[</span><span class="s1">&#39;expr&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unstack</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="s1">&#39;gene&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>

                <span class="k">return</span> <span class="n">df_expr</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Received data in a form of matrix. Reading data&#39;</span><span class="p">)</span>
                <span class="n">df_expr</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Converting it to pandas.DataFrame&#39;</span><span class="p">)</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="s1">&#39;cell&#39;</span> <span class="ow">in</span> <span class="n">df_expr</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;The row with &quot;cell&quot; identifiers is not found. Returning None&#39;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="kc">None</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="s1">&#39;batch&#39;</span> <span class="ow">in</span> <span class="n">df_expr</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;The row with &quot;batch&quot; identifiers is not found. Assuming one batch in the data&#39;</span><span class="p">)</span>
                    <span class="n">df_expr</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;batch&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="s1">&#39;batch0&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">df_expr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

                <span class="n">df_expr</span> <span class="o">=</span> <span class="n">df_expr</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s1">&#39;batch&#39;</span><span class="p">,</span> <span class="s1">&#39;cell&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>

                <span class="n">df_expr</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;gene&#39;</span>

                <span class="k">return</span> <span class="n">df_expr</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Unknown input data format. Returning None&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="DigitalCellSorter.convertIndex"><a class="viewcode-back" href="../../DigitalCellSorterClass.html#DigitalCellSorter.DigitalCellSorter.DigitalCellSorter.convertIndex">[docs]</a>    <span class="k">def</span> <span class="nf">convertIndex</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df_expr</span><span class="p">,</span> <span class="n">nameFrom</span><span class="o">=</span><span class="s1">&#39;alias&#39;</span><span class="p">,</span> <span class="n">nameTo</span><span class="o">=</span><span class="s1">&#39;hugo&#39;</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Convert index to hugo names, if any names in the index are</span>
<span class="sd">        duplicated, remove duplicates</span>

<span class="sd">        Parameters:</span>
<span class="sd">            df_expr: pandas.DataFrame</span>
<span class="sd">                Data to process</span>

<span class="sd">            nameFrom: str, Default &#39;alias&#39;</span>
<span class="sd">                Gene name type to convert from</span>

<span class="sd">            nameTo: str, Default &#39;hugo&#39;</span>
<span class="sd">                Gene name type to convert to</span>

<span class="sd">        Returns:</span>
<span class="sd">            pandas.DataFrame</span>
<span class="sd">                Processed data</span>

<span class="sd">        Usage:</span>
<span class="sd">            DCS = DigitalCellSorter.DigitalCellSorter()</span>

<span class="sd">            df_expr = DCS.convertIndex(df_expr)</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">df_expr</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gnc</span><span class="o">.</span><span class="n">Convert</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">df_expr</span><span class="o">.</span><span class="n">index</span><span class="p">),</span> <span class="s1">&#39;alias&#39;</span><span class="p">,</span> <span class="s1">&#39;hugo&#39;</span><span class="p">,</span> <span class="n">returnUnknownString</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">len_total</span><span class="p">,</span> <span class="n">len_unique</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_expr</span><span class="o">.</span><span class="n">index</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">df_expr</span><span class="o">.</span><span class="n">index</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">len_total</span> <span class="o">!=</span> <span class="n">len_unique</span><span class="p">:</span>
            <span class="n">unique_items</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">df_expr</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">return_counts</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">df_expr</span> <span class="o">=</span> <span class="n">df_expr</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="o">~</span><span class="n">df_expr</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">duplicated</span><span class="p">(</span><span class="n">keep</span><span class="o">=</span><span class="s1">&#39;first&#39;</span><span class="p">)]</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Removed </span><span class="si">%s</span><span class="s1"> duplicated items in the index of size </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">len_total</span> <span class="o">-</span> <span class="n">len_unique</span><span class="p">,</span> <span class="n">len_total</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">unique_items</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">unique_items</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">df_expr</span></div>

<div class="viewcode-block" id="DigitalCellSorter.clean"><a class="viewcode-back" href="../../DigitalCellSorterClass.html#DigitalCellSorter.DigitalCellSorter.DigitalCellSorter.clean">[docs]</a>    <span class="k">def</span> <span class="nf">clean</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df_expr</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Clean pandas.DataFrame: validate index,</span>
<span class="sd">        replace missing with zeros, remove all-zero rows and columns</span>

<span class="sd">        Parameters:</span>
<span class="sd">            df_expr: pandas.DataFrame</span>
<span class="sd">                Data to clean</span>

<span class="sd">        Returns:</span>
<span class="sd">            pandas.DataFrame</span>
<span class="sd">                Processed data</span>
<span class="sd">        </span>
<span class="sd">        Usage:</span>
<span class="sd">            DCS = DigitalCellSorter.DigitalCellSorter()</span>

<span class="sd">            df_expr = DCS.clean(df_expr)</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="c1"># Check is any names in the index are duplicated, remove duplicates</span>
        <span class="n">len_total</span><span class="p">,</span> <span class="n">len_unique</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_expr</span><span class="o">.</span><span class="n">index</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">df_expr</span><span class="o">.</span><span class="n">index</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">len_total</span> <span class="o">!=</span> <span class="n">len_unique</span><span class="p">:</span>
            <span class="n">unique_items</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">df_expr</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">return_counts</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">df_expr</span> <span class="o">=</span> <span class="n">df_expr</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="o">~</span><span class="n">df_expr</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">duplicated</span><span class="p">(</span><span class="n">keep</span><span class="o">=</span><span class="s1">&#39;first&#39;</span><span class="p">)]</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Removed </span><span class="si">%s</span><span class="s1"> duplicated items in the index of size </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">len_total</span> <span class="o">-</span> <span class="n">len_unique</span><span class="p">,</span> <span class="n">len_total</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">unique_items</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">unique_items</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">])</span>

        <span class="c1"># Replace any NaN(s) with zeros.</span>
        <span class="n">df_expr</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Replaced missing values with zeros. Data size: </span><span class="si">%s</span><span class="s1"> genes, </span><span class="si">%s</span><span class="s1"> cells&#39;</span> <span class="o">%</span> <span class="n">df_expr</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

        <span class="c1"># Keep only cells with at least one expressed gene.</span>
        <span class="n">df_expr</span> <span class="o">=</span> <span class="n">df_expr</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="n">df_expr</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Removed all-zero cells. Data size: </span><span class="si">%s</span><span class="s1"> genes, </span><span class="si">%s</span><span class="s1"> cells&#39;</span> <span class="o">%</span> <span class="n">df_expr</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

        <span class="c1"># Keep only genes expressed in at least one cell.</span>
        <span class="n">df_expr</span> <span class="o">=</span> <span class="n">df_expr</span><span class="p">[</span><span class="n">df_expr</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Removed all-zero genes. Data size: </span><span class="si">%s</span><span class="s1"> genes, </span><span class="si">%s</span><span class="s1"> cells&#39;</span> <span class="o">%</span> <span class="n">df_expr</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">df_expr</span></div>

<div class="viewcode-block" id="DigitalCellSorter.normalize"><a class="viewcode-back" href="../../DigitalCellSorterClass.html#DigitalCellSorter.DigitalCellSorter.DigitalCellSorter.normalize">[docs]</a>    <span class="k">def</span> <span class="nf">normalize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df_expr</span><span class="p">,</span> <span class="n">median</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Normalize pandas.DataFrame: rescale all cells, log-transform data,</span>
<span class="sd">        remove constant genes, sort index</span>

<span class="sd">        Parameters:</span>
<span class="sd">            df_expr: pandas.DataFrame</span>
<span class="sd">                Data to normalize</span>

<span class="sd">            median: float, Default None</span>
<span class="sd">                Scale factor, if not provided will be computed as median across all cells in data</span>

<span class="sd">        Returns:</span>
<span class="sd">            pandas.DataFrame</span>
<span class="sd">                Processed data</span>
<span class="sd">        </span>
<span class="sd">        Usage:</span>
<span class="sd">            DCS = DigitalCellSorter.DigitalCellSorter()</span>

<span class="sd">            df_expr = DCS.normalize(df_expr, 0.3)</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="c1"># Scale all cells.</span>
        <span class="n">median</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">df_expr</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span> <span class="k">if</span> <span class="n">median</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">median</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Rescaling all cells by &quot;sum of values = </span><span class="si">%s</span><span class="s1">&quot;.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">median</span><span class="p">))</span>
        <span class="n">df_expr</span> <span class="o">=</span> <span class="n">df_expr</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">q</span><span class="p">:</span> <span class="n">q</span> <span class="o">*</span> <span class="n">median</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">q</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Log-transforming data.&#39;</span><span class="p">)</span>
        <span class="c1"># Replace zeros with minimum value.</span>
        <span class="n">MIN</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">df_expr</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">df_expr</span><span class="o">.</span><span class="n">values</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">MIN</span> <span class="o">&lt;=</span> <span class="mf">0.</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span>
        <span class="n">df_expr</span> <span class="o">=</span> <span class="n">df_expr</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">MIN</span><span class="p">)</span>

        <span class="c1"># Take log2 of expression.</span>
        <span class="n">df_expr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">df_expr</span><span class="p">)</span>
        <span class="n">df_expr</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">df_expr</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

        <span class="c1"># Keep only genes expressed in at least one cell.</span>
        <span class="n">df_expr</span> <span class="o">=</span> <span class="n">df_expr</span><span class="p">[</span><span class="n">df_expr</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Removed all-zero genes. Data size: </span><span class="si">%s</span><span class="s1"> genes, </span><span class="si">%s</span><span class="s1"> cells&#39;</span> <span class="o">%</span> <span class="n">df_expr</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>  

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigmaOverMeanSigma</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Keep only those genes with large enough standard deviation.</span>
            <span class="n">df_expr</span> <span class="o">=</span> <span class="n">df_expr</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">df_expr</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">df_expr</span><span class="o">.</span><span class="n">values</span><span class="p">))</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigmaOverMeanSigma</span><span class="p">]</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Removed constant genes. Data size: </span><span class="si">%s</span><span class="s1"> genes, </span><span class="si">%s</span><span class="s1"> cells&#39;</span> <span class="o">%</span> <span class="n">df_expr</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

        <span class="c1"># Sort rows by gene name</span>
        <span class="n">df_expr</span> <span class="o">=</span> <span class="n">df_expr</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">df_expr</span></div>
    
<div class="viewcode-block" id="DigitalCellSorter.project"><a class="viewcode-back" href="../../DigitalCellSorterClass.html#DigitalCellSorter.DigitalCellSorter.DigitalCellSorter.project">[docs]</a>    <span class="k">def</span> <span class="nf">project</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df_expr</span><span class="p">,</span> <span class="n">PCAonly</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">do_fast_tsne</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Project pandas.DataFrame to lower dimensions</span>

<span class="sd">        Parameters:</span>
<span class="sd">            df_expr: pandas.DataFrame</span>
<span class="sd">                Data to process</span>

<span class="sd">            PCAonly: boolean, Default False</span>
<span class="sd">                Perform Principal component analysis only</span>

<span class="sd">            do_fast_tsne: boolean, Default True</span>
<span class="sd">                Do FI-tSNE instead of &quot;exact&quot; tSNE</span>

<span class="sd">        Returns:</span>
<span class="sd">            pandas.DataFrame</span>
<span class="sd">                Processed data</span>
<span class="sd">        </span>
<span class="sd">        Usage:</span>
<span class="sd">            DCS = DigitalCellSorter.DigitalCellSorter()</span>

<span class="sd">            xPCA, PCs, tSNE = DCS.project(df_expr, 100)</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Performing PC projection from </span><span class="si">%s</span><span class="s1"> to </span><span class="si">%s</span><span class="s1"> features...&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">df_expr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">nComponentsPCA</span><span class="p">))</span>
        <span class="n">_PCA</span> <span class="o">=</span> <span class="n">PCA</span><span class="p">(</span><span class="n">n_components</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nComponentsPCA</span><span class="p">)</span>
        <span class="n">X_pca</span> <span class="o">=</span> <span class="n">_PCA</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">df_expr</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Explained variance:&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">_PCA</span><span class="o">.</span><span class="n">explained_variance_ratio_</span><span class="p">)</span> <span class="o">*</span> <span class="mf">100.</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="s2">&quot;%&quot;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">PCAonly</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Performing tSNE projection from </span><span class="si">%s</span><span class="s1"> to </span><span class="si">%s</span><span class="s1"> features...&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nComponentsPCA</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">do_fast_tsne</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">platform</span><span class="o">.</span><span class="n">system</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;Windows&quot;</span><span class="p">:</span>
                    <span class="kn">from</span> <span class="nn">.FastTSNE</span> <span class="k">import</span> <span class="n">fast_tsne</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Windows detected. Using FastTSNE submodule wrapper&#39;</span><span class="p">)</span>
                    <span class="n">X_tsne2</span> <span class="o">=</span> <span class="n">fast_tsne</span><span class="p">(</span><span class="n">X_pca</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">perplexity</span> <span class="o">=</span> <span class="mi">30</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="kn">import</span> <span class="nn">fitsne</span>
                    <span class="n">X_tsne2</span> <span class="o">=</span> <span class="n">fitsne</span><span class="o">.</span><span class="n">FItSNE</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">X_pca</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;C&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">X_tsne2</span> <span class="o">=</span> <span class="n">TSNE</span><span class="p">(</span><span class="n">n_components</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X_pca</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>

            <span class="k">return</span> <span class="n">X_pca</span><span class="p">,</span> <span class="n">_PCA</span><span class="o">.</span><span class="n">components_</span><span class="p">,</span> <span class="n">X_tsne2</span>

        <span class="k">return</span> <span class="n">X_pca</span><span class="p">,</span> <span class="n">_PCA</span><span class="o">.</span><span class="n">components_</span></div>
    
<div class="viewcode-block" id="DigitalCellSorter.cluster"><a class="viewcode-back" href="../../DigitalCellSorterClass.html#DigitalCellSorter.DigitalCellSorter.DigitalCellSorter.cluster">[docs]</a>    <span class="k">def</span> <span class="nf">cluster</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X_pca</span><span class="p">,</span> <span class="n">df_expr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">clusteringFunction</span><span class="o">=</span><span class="n">AgglomerativeClustering</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Cluster PCA-reduced data into a desired number of clusters</span>

<span class="sd">        Parameters:</span>
<span class="sd">            X_pca: 2d numpy.array</span>
<span class="sd">                PCA-reduced expression data</span>

<span class="sd">            df_expr: 2d numpy.array, Default None</span>
<span class="sd">                Gene expression data </span>

<span class="sd">            clusteringFunction: function, Default AgglomerativeClustering</span>
<span class="sd">                Note: the function should have .fit method and same input and output.</span>
<span class="sd">                For Network-based clustering pass a dictionary </span>
<span class="sd">                {&#39;k_neighbors&#39;:40, metric:&#39;euclidean&#39;, &#39;clusterExpression&#39;:True},</span>
<span class="sd">                thsi way the best number of clusters will be determined automatically</span>

<span class="sd">        Returns:</span>
<span class="sd">            1d numpy.array</span>
<span class="sd">                Cell cluster index labels</span>
<span class="sd">        </span>
<span class="sd">        Usage:</span>
<span class="sd">            DCS = DigitalCellSorter.DigitalCellSorter()</span>

<span class="sd">            index = DCS.cluster(xPCA, 10)</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">clusteringFunction</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">dict</span><span class="p">:</span>

            <span class="kn">import</span> <span class="nn">pynndescent</span>
            <span class="kn">import</span> <span class="nn">networkx</span> <span class="k">as</span> <span class="nn">nx</span>
            <span class="kn">import</span> <span class="nn">community</span>
            
            <span class="k">try</span><span class="p">:</span>
                <span class="n">k_neighbors</span> <span class="o">=</span> <span class="n">clusteringFunction</span><span class="p">[</span><span class="n">k_neighbors</span><span class="p">]</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">k_neighbors</span> <span class="o">=</span> <span class="mi">40</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">metric</span> <span class="o">=</span> <span class="n">clusteringFunction</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">metric</span> <span class="o">=</span> <span class="s1">&#39;euclidean&#39;</span>
            
            <span class="k">try</span><span class="p">:</span>
                <span class="n">clusterExpression</span> <span class="o">=</span> <span class="n">clusteringFunction</span><span class="p">[</span><span class="n">clusterExpression</span><span class="p">]</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">clusterExpression</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="n">data</span> <span class="o">=</span> <span class="n">df_expr</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">T</span> <span class="k">if</span> <span class="n">clusterExpression</span> <span class="k">else</span> <span class="n">X_pca</span><span class="o">.</span><span class="n">T</span>

            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Searching for </span><span class="si">%s</span><span class="s1"> nearest neighbors&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">k_neighbors</span><span class="p">))</span>
            <span class="n">knn</span> <span class="o">=</span> <span class="n">pynndescent</span><span class="o">.</span><span class="n">NNDescent</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="n">metric</span><span class="p">,</span> <span class="n">n_neighbors</span><span class="o">=</span><span class="n">k_neighbors</span><span class="p">)</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="n">k_neighbors</span><span class="p">)</span>

            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;k(=</span><span class="si">%s</span><span class="s1">) nearest neighbors found. Constructing a NetworkX graph&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">k_neighbors</span><span class="p">))</span>
            <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">knn</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="nb">len</span><span class="p">(</span><span class="n">knn</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">knn</span><span class="p">[</span><span class="mi">0</span><span class="p">])):</span>
                <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">knn</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">knn</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>

            <span class="n">G</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">from_numpy_array</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>

            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Clustering the graph&#39;</span><span class="p">)</span>
            <span class="n">cellClusterIndex</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">community</span><span class="o">.</span><span class="n">best_partition</span><span class="p">(</span><span class="n">G</span><span class="p">))</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span><span class="o">.</span><span class="n">values</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cellClusterIndex</span> <span class="o">=</span> <span class="n">clusteringFunction</span><span class="p">(</span><span class="n">n_clusters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nClusters</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_pca</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">labels_</span>

        <span class="k">return</span> <span class="n">cellClusterIndex</span></div>
    
<div class="viewcode-block" id="DigitalCellSorter.vote"><a class="viewcode-back" href="../../DigitalCellSorterClass.html#DigitalCellSorter.DigitalCellSorter.DigitalCellSorter.vote">[docs]</a>    <span class="k">def</span> <span class="nf">vote</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df_markers_expr</span><span class="p">,</span> <span class="n">df_marker_cell_type</span><span class="p">,</span> <span class="n">votingScheme</span><span class="p">):</span>
        
        <span class="sd">&#39;&#39;&#39;Produce cluster voting results</span>

<span class="sd">        Parameters:</span>
<span class="sd">            df_markers_expr: pandas.DataFrame</span>
<span class="sd">                Data with marker genes by cells expression</span>

<span class="sd">            df_marker_cell_type: pandas.DataFrame</span>
<span class="sd">                Data with marker genes by cell types</span>

<span class="sd">            votingScheme: function</span>
<span class="sd">                Voting function</span>

<span class="sd">        Returns:</span>
<span class="sd">            dictionary</span>
<span class="sd">                Voting results, a dictionary in form of:</span>
<span class="sd">                {cluster label: assigned cell type}</span>
<span class="sd">        </span>
<span class="sd">        Usage:</span>
<span class="sd">            DCS = DigitalCellSorter.DigitalCellSorter()</span>

<span class="sd">            voting = DCS.vote(df_markers_expr, df_marker_cell_type)</span>
<span class="sd">        &#39;&#39;&#39;</span>
        
        <span class="k">return</span> <span class="n">votingScheme</span><span class="p">(</span><span class="n">df_markers_expr</span><span class="p">,</span> <span class="n">df_marker_cell_type</span><span class="p">)</span></div>

<div class="viewcode-block" id="DigitalCellSorter.dcsVotingScheme"><a class="viewcode-back" href="../../DigitalCellSorterClass.html#DigitalCellSorter.DigitalCellSorter.DigitalCellSorter.dcsVotingScheme">[docs]</a>    <span class="k">def</span> <span class="nf">dcsVotingScheme</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df_markers_expr</span><span class="p">,</span> <span class="n">df_marker_cell_type</span><span class="p">):</span>
        
        <span class="sd">&#39;&#39;&#39;Produce cluster voting results</span>

<span class="sd">        Parameters:</span>
<span class="sd">            df_markers_expr: pandas.DataFrame </span>
<span class="sd">                Data with marker genes by cells expression</span>

<span class="sd">            df_marker_cell_type: pandas.DataFrame </span>
<span class="sd">                Data with marker genes by cell types</span>

<span class="sd">        Returns:</span>
<span class="sd">            dictionary</span>
<span class="sd">                Voting results, a dictionary in form of:</span>
<span class="sd">                {cluster label: assigned cell type}</span>
<span class="sd">        </span>
<span class="sd">        Usage:</span>
<span class="sd">            Function should be called internally only</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="c1"># Normalize columns (cell types) so that the absolute number of known</span>
        <span class="c1"># markers in a given cell type is irrelevant</span>
        <span class="n">df_marker_cell_type</span> <span class="o">=</span> <span class="n">df_marker_cell_type</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">q</span><span class="p">:</span> <span class="n">q</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">q</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="c1"># Normalize rows (markers) by the number of cell types expressing that marker (i.e. the &quot;specificity&quot;)</span>
        <span class="n">df_marker_cell_type</span> <span class="o">=</span> <span class="n">df_marker_cell_type</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">q</span><span class="p">:</span><span class="n">q</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">q</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Align df_markers_expr and df_marker_cell_type</span>
        <span class="n">df_markers_expr</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">df_marker_cell_type</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Generate random cluster index</span>
        <span class="n">randomClusterIndex</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">df_markers_expr</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="s1">&#39;cluster&#39;</span><span class="p">),</span> <span class="n">size</span><span class="o">=</span><span class="n">df_markers_expr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nSamplesDistribution</span><span class="p">)])</span>

        <span class="c1"># Calculate score (Vkc) for the best clustering</span>
        <span class="n">df_V</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getV</span><span class="p">((</span><span class="n">df_marker_cell_type</span><span class="p">,</span> <span class="n">df_markers_expr</span><span class="p">,</span> <span class="n">df_markers_expr</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="s1">&#39;cluster&#39;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">zScoreCutoff</span><span class="p">))</span><span class="o">.</span><span class="n">unstack</span><span class="p">()</span>
        <span class="n">df_V</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Generate random cluster configurations and calculate scores (Pkc) of</span>
        <span class="c1"># those</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Generating null distribution&#39;</span><span class="p">)</span>
        <span class="n">startTime</span> <span class="o">=</span> <span class="n">getStartTime</span><span class="p">()</span>
        <span class="n">pool</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Pool</span><span class="p">(</span><span class="n">processes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">availableCPUsCount</span><span class="p">)</span>
        <span class="n">random_df_V</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">pool</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getV</span><span class="p">,</span> <span class="p">[(</span><span class="n">df_marker_cell_type</span><span class="p">,</span> <span class="n">df_markers_expr</span><span class="p">,</span> <span class="n">randomClusterIndex</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">zScoreCutoff</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nSamplesDistribution</span><span class="p">)]),</span> <span class="n">sort</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">pool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">pool</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
        <span class="n">getElapsedTime</span><span class="p">(</span><span class="n">startTime</span><span class="p">)</span>

        <span class="c1"># Calculate null distribution histograms data for plots</span>
        <span class="n">df_null_distributions</span> <span class="o">=</span> <span class="n">random_df_V</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="n">scipy</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">rv_histogram</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)))</span><span class="o">.</span><span class="n">_hpdf</span> <span class="o">/</span> <span class="mf">100.</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
        <span class="n">df_null_distributions</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;CellType&#39;</span><span class="p">,</span> <span class="s1">&#39;Cluster&#39;</span><span class="p">]</span>

        <span class="c1"># Calculate z-score (Lkc) for the best clustering</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Processing voting results&#39;</span><span class="p">)</span>
        <span class="n">df_L</span> <span class="o">=</span> <span class="p">(</span><span class="n">df_V</span> <span class="o">-</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">random_df_V</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="n">random_df_V</span><span class="o">.</span><span class="n">index</span><span class="p">)</span><span class="o">.</span><span class="n">unstack</span><span class="p">())</span> <span class="o">/</span> \
           <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">random_df_V</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="n">random_df_V</span><span class="o">.</span><span class="n">index</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span><span class="o">.</span><span class="n">unstack</span><span class="p">()</span>
        <span class="c1">#df_L[df_L&lt;0.] = 0.</span>
        <span class="n">df_L</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Determine winning score</span>
        <span class="n">winning_score</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">df_V</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ind</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">enumerate</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">df_L</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)))),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)])</span>

        <span class="c1"># Determine winning cell type</span>
        <span class="n">wtypes</span> <span class="o">=</span> <span class="n">df_L</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">df_L</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># Properly rename winning cell type</span>
        <span class="n">T</span> <span class="o">=</span> <span class="n">df_L</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">df_L</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">T</span><span class="p">[(</span><span class="n">df_L</span><span class="o">.</span><span class="n">values</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">minimumScoreForUnknown</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)]</span> <span class="o">=</span> <span class="s1">&#39;Unknown&#39;</span>
        <span class="n">T</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Index</span><span class="p">(</span><span class="n">T</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; #0&#39;</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">T</span><span class="p">)):</span>
            <span class="n">T</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="o">~</span><span class="n">T</span><span class="o">.</span><span class="n">duplicated</span><span class="p">(),</span> <span class="n">T</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; #</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="s1">&#39; #</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)))</span>
        <span class="n">predicted_celltype</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">values</span>

        <span class="c1"># Determine cluster sizes</span>
        <span class="n">cluster_sizes</span> <span class="o">=</span> <span class="n">df_markers_expr</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="s1">&#39;cluster&#39;</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

        <span class="c1"># Save score columns names</span>
        <span class="n">columns_scores</span> <span class="o">=</span> <span class="n">df_V</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

        <span class="c1"># Update the DataFrames</span>
        <span class="n">df_V</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;Winning score&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_L</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;Winning score&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">winning_score</span>
        <span class="n">df_V</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;Predicted cell type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_L</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;Predicted cell type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">predicted_celltype</span>
        <span class="n">df_V</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;# cells in cluster&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_L</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;# cells in cluster&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cluster_sizes</span>

        <span class="c1"># Determine all markers hits for each cluster</span>
        <span class="n">df_custer_centroids</span> <span class="o">=</span> <span class="n">df_markers_expr</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="s1">&#39;cluster&#39;</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">df_custer_centroids_sig</span> <span class="o">=</span> <span class="n">df_custer_centroids</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zScoreOfSeries</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">zScoreCutoff</span>
        <span class="n">dict_supporting_markers</span> <span class="o">=</span> <span class="p">{</span><span class="n">cluster</span><span class="p">:</span><span class="n">df_custer_centroids_sig</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">df_custer_centroids_sig</span><span class="p">[</span><span class="n">cluster</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="k">for</span> <span class="n">cluster</span> <span class="ow">in</span> <span class="n">df_custer_centroids_sig</span><span class="p">}</span>
        <span class="n">all_markers_in_cluster</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39; // &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dict_supporting_markers</span><span class="p">[</span><span class="n">cluster</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span> <span class="k">for</span> <span class="n">cluster</span> <span class="ow">in</span> <span class="n">df_V</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
        <span class="n">df_V</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;All markers&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_L</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;All markers&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">all_markers_in_cluster</span>

        <span class="n">all_markers</span> <span class="o">=</span> <span class="p">{</span><span class="n">celltype</span><span class="p">:</span><span class="n">df_marker_cell_type</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">df_marker_cell_type</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="n">celltype</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="k">for</span> <span class="n">celltype</span> <span class="ow">in</span> <span class="n">columns_scores</span><span class="p">}</span>
        <span class="n">all_markers</span><span class="p">[</span><span class="s1">&#39;Unknown&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>

        <span class="n">supporting_markers</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39; // &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span><span class="n">all_markers</span><span class="p">[</span><span class="n">df_V</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;Predicted cell type&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">cluster</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; #&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]],</span>
                                                            <span class="n">df_V</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;All markers&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">cluster</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; // &#39;</span><span class="p">)))</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span> <span class="k">for</span> <span class="n">cluster</span> <span class="ow">in</span> <span class="n">df_V</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
        <span class="n">df_V</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;Supporting markers&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_L</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;Supporting markers&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">supporting_markers</span>
        
        <span class="c1"># Record the DataFrames</span>
        <span class="n">fileName</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">saveDir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataName</span> <span class="o">+</span> <span class="s1">&#39;_voting.xlsx&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Recording voting results to:&#39;</span><span class="p">,</span> <span class="n">fileName</span><span class="p">)</span>
        <span class="n">writer</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">ExcelWriter</span><span class="p">(</span><span class="n">fileName</span><span class="p">)</span>
        <span class="n">df_L</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="n">writer</span><span class="p">,</span> <span class="s1">&#39;z-scores&#39;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Predicted cell type&#39;</span><span class="p">,</span> <span class="s1">&#39;# cells in cluster&#39;</span><span class="p">,</span> <span class="s1">&#39;Winning score&#39;</span><span class="p">,</span> <span class="s1">&#39;Supporting markers&#39;</span><span class="p">,</span> <span class="s1">&#39;All markers&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">columns_scores</span><span class="p">)</span>
        <span class="n">df_V</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="n">writer</span><span class="p">,</span> <span class="s1">&#39;Voting scores&#39;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Predicted cell type&#39;</span><span class="p">,</span> <span class="s1">&#39;# cells in cluster&#39;</span><span class="p">,</span> <span class="s1">&#39;Winning score&#39;</span><span class="p">,</span> <span class="s1">&#39;Supporting markers&#39;</span><span class="p">,</span> <span class="s1">&#39;All markers&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">columns_scores</span><span class="p">)</span>
        <span class="n">df_custer_centroids</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="n">writer</span><span class="p">,</span> <span class="s1">&#39;Cluster centroids&#39;</span><span class="p">)</span>
        <span class="n">df_null_distributions</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="n">writer</span><span class="p">,</span> <span class="s1">&#39;Null distributions&#39;</span><span class="p">)</span>
        <span class="n">df_marker_cell_type</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="n">writer</span><span class="p">,</span> <span class="s1">&#39;Marker cell type weight matrix&#39;</span><span class="p">)</span>
        <span class="n">writer</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">df_V</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;Predicted cell type&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span></div>

<div class="viewcode-block" id="DigitalCellSorter.extractNewMarkerGenes"><a class="viewcode-back" href="../../DigitalCellSorterClass.html#DigitalCellSorter.DigitalCellSorter.DigitalCellSorter.extractNewMarkerGenes">[docs]</a>    <span class="k">def</span> <span class="nf">extractNewMarkerGenes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cluster</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">zScoreCutoff</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">removeUnknown</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Extract new marker genes based on the cluster annotations</span>

<span class="sd">        Parameters:</span>
<span class="sd">            cluster: int, Default None</span>
<span class="sd">                Cluster #, if provided genes of only this culster will be returned</span>

<span class="sd">            top: int, Default 100</span>
<span class="sd">                Upper bound for number of new markers per cell type</span>

<span class="sd">            zScoreCutoff: float, Default 0.3</span>
<span class="sd">                Lower bound for a marker z-score to be significant</span>

<span class="sd">            removeUnknown: boolean, Default False</span>
<span class="sd">                Whether to remove type &quot;Unknown&quot;</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>

<span class="sd">        Usage:</span>
<span class="sd">            DCS = DigitalCellSorter.DigitalCellSorter()</span>

<span class="sd">            DCS.extractNewMarkerGenes()</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">cluster</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>

            <span class="n">clusterGenes</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_hdf</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">saveDir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataName</span> <span class="o">+</span> <span class="s1">&#39;_processed.h5&#39;</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;df_gene_cluster_centroids&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)[</span><span class="n">cluster</span><span class="p">]</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">clusterGenes</span> <span class="o">=</span> <span class="n">clusterGenes</span><span class="p">[</span><span class="n">clusterGenes</span> <span class="o">&gt;=</span> <span class="n">zScoreCutoff</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="n">top</span><span class="p">]</span>

            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;genes&#39;</span><span class="p">:</span><span class="n">clusterGenes</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="s1">&#39;zscore&#39;</span><span class="p">:</span><span class="n">clusterGenes</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()}</span>

        <span class="n">df_gene_cluster_centroids_merged</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_hdf</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">saveDir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataName</span> <span class="o">+</span> <span class="s1">&#39;_processed.h5&#39;</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;df_new_marker_genes&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">removeUnknown</span> <span class="ow">and</span> <span class="s1">&#39;Unknown&#39;</span> <span class="ow">in</span> <span class="n">df_gene_cluster_centroids_merged</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">df_gene_cluster_centroids_merged</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Unknown&#39;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">df_new_marker_genes</span> <span class="o">=</span> <span class="n">df_gene_cluster_centroids_merged</span><span class="o">.</span><span class="n">T</span>

        <span class="n">df_new_marker_genes</span><span class="p">[</span><span class="n">df_new_marker_genes</span><span class="o">&lt;</span><span class="mf">0.</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;New marker cell type shape:&#39;</span><span class="p">,</span> <span class="n">df_new_marker_genes</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

        <span class="n">df_new_marker_genes</span> <span class="o">=</span> <span class="n">df_new_marker_genes</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_new_marker_genes</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">&gt;=</span><span class="n">zScoreCutoff</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;New marker cell type shape:&#39;</span><span class="p">,</span> <span class="n">df_new_marker_genes</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

        <span class="n">df_new_marker_genes</span> <span class="o">=</span> <span class="n">df_new_marker_genes</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_new_marker_genes</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">&gt;=</span><span class="n">zScoreCutoff</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;New marker cell type shape:&#39;</span><span class="p">,</span> <span class="n">df_new_marker_genes</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

        <span class="n">df_new_marker_list</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">celltype</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">df_new_marker_genes</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span><span class="p">):</span>
            <span class="nb">all</span> <span class="o">=</span> <span class="n">df_new_marker_genes</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">celltype</span><span class="p">]</span>
            <span class="n">sel</span> <span class="o">=</span> <span class="nb">all</span><span class="p">[</span><span class="nb">all</span><span class="o">&gt;</span><span class="mf">1.0</span><span class="p">]</span><span class="o">.</span><span class="n">sort_values</span><span class="p">()[:</span><span class="n">top</span><span class="p">]</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Candidates of </span><span class="si">%s</span><span class="s1">:&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">celltype</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">sel</span><span class="p">))</span>
            <span class="n">df_new_marker_list</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df_new_marker_list</span><span class="p">,</span> <span class="n">sel</span><span class="p">],</span> <span class="n">sort</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">df_new_marker_list</span> <span class="o">=</span> <span class="n">df_new_marker_list</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mf">0.</span><span class="p">)</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>
        <span class="n">df_new_marker_list</span><span class="p">[</span><span class="n">df_new_marker_list</span><span class="o">&gt;</span><span class="mf">0.</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>

        <span class="k">if</span> <span class="s1">&#39;Unknown&#39;</span> <span class="ow">in</span> <span class="n">df_new_marker_list</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">df_new_marker_list</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Unknown&#39;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">df_new_marker_list</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;Marker&#39;</span>
        <span class="n">fileName</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">saveDir</span><span class="p">,</span> <span class="s1">&#39;new_markers.xlsx&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Recording voting results to:&#39;</span><span class="p">,</span> <span class="n">fileName</span><span class="p">)</span>
        <span class="n">writer</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">ExcelWriter</span><span class="p">(</span><span class="n">fileName</span><span class="p">)</span>
        <span class="n">df_new_marker_list</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="n">writer</span><span class="p">,</span> <span class="s1">&#39;MarkerCellType&#39;</span><span class="p">)</span>
        <span class="n">df_temp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">df_new_marker_list</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">df_new_marker_list</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
        <span class="n">df_temp</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;CellTypeGrouped&#39;</span>
        <span class="n">df_temp</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;CellType&#39;</span>
        <span class="n">df_temp</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="n">writer</span><span class="p">,</span> <span class="s1">&#39;CellTypesGrouped&#39;</span><span class="p">)</span>
        <span class="n">writer</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

        <span class="n">df_marker_cell_type</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">saveDir</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">geneListFileName</span><span class="p">)),</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">df_new_marker_genes</span> <span class="o">=</span> <span class="n">df_new_marker_genes</span><span class="p">[</span><span class="n">df_new_marker_list</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">makePlotOfNewMarkers</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">saveDir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataName</span><span class="p">,</span> <span class="n">df_marker_cell_type</span><span class="p">,</span> <span class="n">df_new_marker_genes</span><span class="p">)</span>

        <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="DigitalCellSorter.visualize"><a class="viewcode-back" href="../../DigitalCellSorterClass.html#DigitalCellSorter.DigitalCellSorter.DigitalCellSorter.visualize">[docs]</a>    <span class="k">def</span> <span class="nf">visualize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;A convenient aggregate of visualization tools of this class.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            None</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>
<span class="sd">        </span>
<span class="sd">        Usage:</span>
<span class="sd">            DCS = DigitalCellSorter.DigitalCellSorter()</span>

<span class="sd">            DCS.process(df_expr)</span>

<span class="sd">            DCS.visualize()</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="c1">##############################################################################################</span>
        <span class="c1"># Create a colormap for cell types (based on a marker-celltype file)</span>
        <span class="c1">##############################################################################################</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">saveDir</span><span class="p">,</span> <span class="s1">&#39;ColormapForCellTypes.txt&#39;</span><span class="p">),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">temp_file</span><span class="p">:</span>
            <span class="n">df_marker_cell_type</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_hdf</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">saveDir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataName</span> <span class="o">+</span> <span class="s1">&#39;_processed.h5&#39;</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;df_marker_cell_type&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
            <span class="n">cellTypes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">df_marker_cell_type</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
            <span class="k">for</span> <span class="n">cellTypeIndex</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cellTypes</span><span class="p">)):</span>
                <span class="n">temp_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">cellTypes</span><span class="p">[</span><span class="n">cellTypeIndex</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">jet</span><span class="p">(</span><span class="n">cellTypeIndex</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">cellTypes</span><span class="p">)))</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">temp_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Unknown&#39;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">jet</span><span class="p">(</span><span class="mf">1.0</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1">##############################################################################################</span>
        <span class="c1"># Plot null distributions</span>
        <span class="c1">##############################################################################################</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">toggleMakeHistogramNullDistributionPlot</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Making null distributions plot&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">makeHistogramNullDistributionPlot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">saveDir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataName</span><span class="p">)</span>
            <span class="n">timeMark</span><span class="p">()</span>

        <span class="c1">##############################################################################################</span>
        <span class="c1"># Plot voting results matrix</span>
        <span class="c1">##############################################################################################</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">toggleMakeVotingResultsMatrixPlot</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Making voting results matrix plot&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">makeVotingResultsMatrixPlot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">saveDir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataName</span><span class="p">)</span>
            <span class="n">timeMark</span><span class="p">()</span>
        
        <span class="c1">##############################################################################################</span>
        <span class="c1"># Plot mean marker expression</span>
        <span class="c1">##############################################################################################</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">toggleMakeMarkerExpressionPlot</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Making marker expression plot&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">makeMarkerExpressionPlot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">saveDir</span><span class="p">)</span>
            <span class="n">timeMark</span><span class="p">()</span>

        <span class="c1">##############################################################################################</span>
        <span class="c1"># Make tSNE plots</span>
        <span class="c1">##############################################################################################</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">toggleMakeTSNEplotQC</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">toggleDoQualityControl</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Making tSNE plots of QC&#39;</span><span class="p">)</span>
            <span class="n">df_QC</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_hdf</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">saveDir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataName</span> <span class="o">+</span> <span class="s1">&#39;_processed.h5&#39;</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;QC&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
            <span class="n">df_tsne</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_hdf</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">saveDir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataName</span> <span class="o">+</span> <span class="s1">&#39;_processed.h5&#39;</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;df_tsne_pre_QC&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
            <span class="n">goodQUalityCells</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_hdf</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">saveDir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataName</span> <span class="o">+</span> <span class="s1">&#39;_processed.h5&#39;</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;df_tsne&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">columns</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">makeTSNEplot</span><span class="p">(</span><span class="n">df_tsne</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">df_QC</span><span class="p">[</span><span class="s1">&#39;number_of_genes&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">saveDir</span><span class="p">,</span> <span class="s1">&#39;by_number_of_genes&#39;</span><span class="p">,</span> <span class="n">legend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">colorbar</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">makeTSNEplot</span><span class="p">(</span><span class="n">df_tsne</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">df_QC</span><span class="p">[</span><span class="s1">&#39;count_depth&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">saveDir</span><span class="p">,</span> <span class="s1">&#39;by_count_depth&#39;</span><span class="p">,</span> <span class="n">legend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">colorbar</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">makeTSNEplot</span><span class="p">(</span><span class="n">df_tsne</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">df_QC</span><span class="p">[</span><span class="s1">&#39;fraction_of_mitochondrialGenes&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">saveDir</span><span class="p">,</span> <span class="s1">&#39;by_fraction_of_mitochondrialGenes&#39;</span><span class="p">,</span> <span class="n">legend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">colorbar</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">makeTSNEplot</span><span class="p">(</span><span class="n">df_tsne</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">cell</span> <span class="ow">in</span> <span class="n">goodQUalityCells</span> <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="n">df_QC</span><span class="o">.</span><span class="n">index</span><span class="p">]),</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">saveDir</span><span class="p">,</span> <span class="s1">&#39;by_is_quality_cell&#39;</span><span class="p">,</span> <span class="n">legend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">timeMark</span><span class="p">()</span>    

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">toggleMakeTSNEplotClusters</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Making tSNE plot by clusters&#39;</span><span class="p">)</span>
            <span class="n">df_clusters</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_hdf</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">saveDir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataName</span> <span class="o">+</span> <span class="s1">&#39;_processed.h5&#39;</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;df_clusters&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
            <span class="n">df_tsne</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_hdf</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">saveDir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataName</span> <span class="o">+</span> <span class="s1">&#39;_processed.h5&#39;</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;df_tsne&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">makeTSNEplot</span><span class="p">(</span><span class="n">df_tsne</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="s1">&#39;Cluster #</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">label</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">df_clusters</span><span class="o">.</span><span class="n">values</span><span class="p">]),</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">saveDir</span><span class="p">,</span> <span class="s1">&#39;by_clusters&#39;</span><span class="p">)</span>
            <span class="n">timeMark</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">toggleMakeTSNEplotBatches</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Making tSNE plot by patients&#39;</span><span class="p">)</span>
            <span class="n">df_tsne</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_hdf</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">saveDir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataName</span> <span class="o">+</span> <span class="s1">&#39;_processed.h5&#39;</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;df_tsne&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">makeTSNEplot</span><span class="p">(</span><span class="n">df_tsne</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">df_tsne</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="s1">&#39;batch&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">saveDir</span><span class="p">,</span> <span class="s1">&#39;by_patients&#39;</span><span class="p">)</span>
            <span class="n">timeMark</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">toggleMakeTSNEplotAnnotatedClusters</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Making tSNE plot by clusters &quot;True&quot; labels&#39;</span><span class="p">)</span>
            <span class="n">df_markers_expr</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_hdf</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">saveDir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataName</span> <span class="o">+</span> <span class="s1">&#39;_processed.h5&#39;</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;df_markers_expr&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
            <span class="n">df_tsne</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_hdf</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">saveDir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataName</span> <span class="o">+</span> <span class="s1">&#39;_processed.h5&#39;</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;df_tsne&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
            <span class="n">df_tsne</span> <span class="o">=</span> <span class="n">df_tsne</span><span class="p">[</span><span class="n">df_markers_expr</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;batch&#39;</span><span class="p">,</span> <span class="s1">&#39;cell&#39;</span><span class="p">],</span> <span class="n">sort</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">saveDir</span><span class="p">,</span> <span class="s1">&#39;ColormapForCellTypes.txt&#39;</span><span class="p">),</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">temp_file</span><span class="p">:</span>
                <span class="n">colormap</span> <span class="o">=</span> <span class="p">{</span><span class="n">item</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]:</span><span class="nb">eval</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">temp_file</span><span class="o">.</span><span class="n">readlines</span><span class="p">()}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">makeTSNEplot</span><span class="p">(</span><span class="n">df_tsne</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">df_markers_expr</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="s1">&#39;label&#39;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">saveDir</span><span class="p">,</span> <span class="s1">&#39;by_clusters_annotated&#39;</span><span class="p">,</span>
                             <span class="n">colormap</span><span class="o">=</span><span class="n">colormap</span><span class="p">,</span> <span class="n">legend</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">timeMark</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">toggleAnomalyScoresTSNEplot</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">getAnomalyScoresPlot</span><span class="p">()</span>
            <span class="n">timeMark</span><span class="p">()</span>
           
        <span class="c1">##############################################################################################</span>
        <span class="c1"># Make stacked barplot of cell type fractions</span>
        <span class="c1">##############################################################################################</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">toggleMakeStackedBarplot</span><span class="p">:</span>        
            <span class="bp">self</span><span class="o">.</span><span class="n">makeStackedBarplot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">saveDir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">subclusteringName</span><span class="p">)</span>
            <span class="n">timeMark</span><span class="p">()</span>
        
        <span class="c1">##############################################################################################</span>
        <span class="c1"># Make tSNE plots showing relative expression of different markers (one</span>
        <span class="c1"># for each marker)</span>
        <span class="c1">##############################################################################################</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">toggleMakeMarkerSubplots</span><span class="p">:</span>
            <span class="n">df_tsne</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_hdf</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">saveDir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataName</span> <span class="o">+</span> <span class="s1">&#39;_processed.h5&#39;</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;df_tsne&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
            <span class="n">df_markers_expr</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_hdf</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">saveDir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataName</span> <span class="o">+</span> <span class="s1">&#39;_processed.h5&#39;</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;df_markers_expr&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
            <span class="n">df_tsne</span> <span class="o">=</span> <span class="n">df_tsne</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="o">.</span><span class="n">from_arrays</span><span class="p">([</span><span class="n">df_markers_expr</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="s1">&#39;batch&#39;</span><span class="p">),</span> <span class="n">df_markers_expr</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="s1">&#39;cell&#39;</span><span class="p">)])]</span>
            <span class="n">hugo_cd_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">df_markers_expr</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">gnc</span><span class="o">.</span><span class="n">Convert</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">df_markers_expr</span><span class="o">.</span><span class="n">index</span><span class="p">),</span> <span class="s1">&#39;hugo&#39;</span><span class="p">,</span> <span class="s1">&#39;alias&#39;</span><span class="p">,</span> <span class="n">returnUnknownString</span><span class="o">=</span><span class="kc">False</span><span class="p">)))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">makeMarkerSubplots</span><span class="p">(</span><span class="n">df_markers_expr</span><span class="p">,</span> <span class="n">df_tsne</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">hugo_cd_dict</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">saveDir</span><span class="p">)</span>
            <span class="n">timeMark</span><span class="p">()</span>

        <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="DigitalCellSorter.process"><a class="viewcode-back" href="../../DigitalCellSorterClass.html#DigitalCellSorter.DigitalCellSorter.DigitalCellSorter.process">[docs]</a>    <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df_expr</span><span class="p">,</span> <span class="n">visualize</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Main function</span>

<span class="sd">        Parameters:</span>
<span class="sd">            df_expr: pandas.DataFrame</span>
<span class="sd">                Gene expression data</span>

<span class="sd">            visualize: boolean, Default True</span>
<span class="sd">                Whether to make the plots</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>
<span class="sd">        </span>
<span class="sd">        Usage:</span>
<span class="sd">            DCS = DigitalCellSorter.DigitalCellSorter()</span>

<span class="sd">            DCS.process(df_expr)</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">saveDir</span><span class="o">!=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">saveDir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">saveDir</span><span class="p">)</span>

        <span class="c1">##############################################################################################</span>
        <span class="c1"># Convert index to hugo names, clean data</span>
        <span class="c1">##############################################################################################</span>
        <span class="n">df_expr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">convertIndex</span><span class="p">(</span><span class="n">df_expr</span><span class="p">)</span>
        <span class="n">df_expr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clean</span><span class="p">(</span><span class="n">df_expr</span><span class="p">)</span>
        <span class="n">timeMark</span><span class="p">()</span>
        
        <span class="c1">##############################################################################################</span>
        <span class="c1"># Calculate QC measures</span>
        <span class="c1">##############################################################################################</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">toggleDoQualityControl</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mitochondrialGenes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mitochondrialGenes</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">defualtGeneListsDir</span><span class="p">,</span> <span class="s1">&#39;Human.MitoCarta2.0.csv&#39;</span><span class="p">),</span> <span class="n">index_col</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="mi">0</span><span class="p">)[</span><span class="s1">&#39;Symbol&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Calculating quality control measures (count depth, number of genes, fraction of mitochondrial genes) for each cell&#39;</span><span class="p">)</span>
            <span class="n">df_QC</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([(</span><span class="n">df_expr</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="n">df_expr</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="n">df_expr</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">mitochondrialGenes</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">df_expr</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">df_QC</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;count_depth&#39;</span><span class="p">,</span> <span class="s1">&#39;number_of_genes&#39;</span><span class="p">,</span> <span class="s1">&#39;fraction_of_mitochondrialGenes&#39;</span><span class="p">]</span>
            <span class="n">df_QC</span><span class="o">.</span><span class="n">to_hdf</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">saveDir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataName</span> <span class="o">+</span> <span class="s1">&#39;_processed.h5&#39;</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;QC&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="n">complevel</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">complib</span><span class="o">=</span><span class="s1">&#39;zlib&#39;</span><span class="p">)</span>
            <span class="n">timeMark</span><span class="p">()</span>

        <span class="c1">##############################################################################################</span>
        <span class="c1"># Normalize</span>
        <span class="c1">##############################################################################################</span>
        <span class="n">df_expr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span><span class="n">df_expr</span><span class="p">)</span>
        <span class="n">timeMark</span><span class="p">()</span>
          
        <span class="c1">##############################################################################################</span>
        <span class="c1"># Correct for batch effects</span>
        <span class="c1">##############################################################################################</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">toggleDoBatchCorrection</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;ComBat transformation&#39;</span><span class="p">)</span>
            <span class="n">cells</span> <span class="o">=</span> <span class="n">df_expr</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="s1">&#39;cell&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">patients</span> <span class="o">=</span> <span class="n">df_expr</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="s1">&#39;batch&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">patients</span><span class="p">))</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Only one batch provided. Batch correction is unnecessary&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Reading positions of zeros&#39;</span><span class="p">)</span>
                <span class="n">where_zeros</span> <span class="o">=</span> <span class="n">df_expr</span> <span class="o">==</span> <span class="mf">0.</span>
                <span class="n">values</span> <span class="o">=</span> <span class="n">combat</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">df_expr</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">index</span><span class="o">=</span><span class="n">df_expr</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">columns</span><span class="o">=</span><span class="n">cells</span><span class="p">),</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">patients</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">cells</span><span class="p">))</span><span class="o">.</span><span class="n">values</span>
                <span class="n">df_expr</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">values</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">df_expr</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">df_expr</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Setting original zeros back to zeros&#39;</span><span class="p">)</span>
                <span class="n">df_expr</span><span class="p">[</span><span class="n">where_zeros</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Setting negative values to zeros&#39;</span><span class="p">)</span>
                <span class="n">df_expr</span><span class="p">[</span><span class="n">df_expr</span> <span class="o">&lt;</span> <span class="mf">0.0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>
                <span class="n">timeMark</span><span class="p">()</span>

        <span class="c1">##############################################################################################</span>
        <span class="c1"># Compress and record DataFrame to dense matrix</span>
        <span class="c1">##############################################################################################</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">toggleRecordAllExpression</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Recording compressed DataFrame&#39;</span><span class="p">)</span>
            <span class="n">df_expr</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">stack</span><span class="p">()</span><span class="o">.</span><span class="n">to_frame</span><span class="p">()</span><span class="o">.</span><span class="n">to_hdf</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">saveDir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataName</span> <span class="o">+</span> <span class="s1">&#39;_processed.h5&#39;</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;df_expr&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="n">complevel</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">complib</span><span class="o">=</span><span class="s1">&#39;zlib&#39;</span><span class="p">)</span>
            <span class="n">timeMark</span><span class="p">()</span>

        <span class="c1">##############################################################################################</span>
        <span class="c1"># Calculate PCA and tSNE</span>
        <span class="c1">##############################################################################################</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Preparing xpca, pcs, tsne of df_expr&#39;</span><span class="p">)</span>
        <span class="n">X_pca</span><span class="p">,</span> <span class="n">PCs</span><span class="p">,</span> <span class="n">X_tsne2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">(</span><span class="n">df_expr</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Recording xpca, pcs, tsne of df_expr&#39;</span><span class="p">)</span>
        <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">X_pca</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">df_expr</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span><span class="o">.</span><span class="n">to_hdf</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">saveDir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataName</span> <span class="o">+</span> <span class="s1">&#39;_processed.h5&#39;</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;df_xpca&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="n">complevel</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">complib</span><span class="o">=</span><span class="s1">&#39;zlib&#39;</span><span class="p">)</span>
        <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">PCs</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">df_expr</span><span class="o">.</span><span class="n">index</span><span class="p">)</span><span class="o">.</span><span class="n">to_hdf</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">saveDir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataName</span> <span class="o">+</span> <span class="s1">&#39;_processed.h5&#39;</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;df_pcs&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="n">complevel</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">complib</span><span class="o">=</span><span class="s1">&#39;zlib&#39;</span><span class="p">)</span>
        <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">X_tsne2</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">df_expr</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span><span class="o">.</span><span class="n">to_hdf</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">saveDir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataName</span> <span class="o">+</span> <span class="s1">&#39;_processed.h5&#39;</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;df_tsne_pre_QC&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">toggleDoQualityControl</span> <span class="k">else</span> <span class="s1">&#39;df_tsne&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="n">complevel</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">complib</span><span class="o">=</span><span class="s1">&#39;zlib&#39;</span><span class="p">)</span>
        <span class="n">timeMark</span><span class="p">()</span>

        <span class="c1">##############################################################################################</span>
        <span class="c1"># Remove low quality cells</span>
        <span class="c1">##############################################################################################</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">toggleDoQualityControl</span><span class="p">:</span>
            <span class="n">df_expr</span> <span class="o">=</span> <span class="n">df_expr</span><span class="p">[</span><span class="n">df_expr</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getIndexOfGoodQualityCells</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">saveDir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataName</span><span class="p">))</span><span class="o">.</span><span class="n">sort_values</span><span class="p">()]</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Removed low quality cells. Data size: </span><span class="si">%s</span><span class="s1"> genes, </span><span class="si">%s</span><span class="s1"> cells&#39;</span> <span class="o">%</span> <span class="n">df_expr</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
            <span class="n">X_pca</span><span class="p">,</span> <span class="n">PCs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">(</span><span class="n">df_expr</span><span class="p">,</span> <span class="n">PCAonly</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">X_pca</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">df_expr</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span><span class="o">.</span><span class="n">to_hdf</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">saveDir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataName</span> <span class="o">+</span> <span class="s1">&#39;_processed.h5&#39;</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;df_xpca&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="n">complevel</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">complib</span><span class="o">=</span><span class="s1">&#39;zlib&#39;</span><span class="p">)</span>
            <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">PCs</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">df_expr</span><span class="o">.</span><span class="n">index</span><span class="p">)</span><span class="o">.</span><span class="n">to_hdf</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">saveDir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataName</span> <span class="o">+</span> <span class="s1">&#39;_processed.h5&#39;</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;df_pcs&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="n">complevel</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">complib</span><span class="o">=</span><span class="s1">&#39;zlib&#39;</span><span class="p">)</span>
            <span class="n">df_tsne</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_hdf</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">saveDir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataName</span> <span class="o">+</span> <span class="s1">&#39;_processed.h5&#39;</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;df_tsne_pre_QC&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
            <span class="n">df_tsne</span><span class="p">[</span><span class="n">df_expr</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span><span class="o">.</span><span class="n">to_hdf</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">saveDir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataName</span> <span class="o">+</span> <span class="s1">&#39;_processed.h5&#39;</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;df_tsne&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="n">complevel</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">complib</span><span class="o">=</span><span class="s1">&#39;zlib&#39;</span><span class="p">)</span>
            <span class="n">timeMark</span><span class="p">()</span>

        <span class="c1">##############################################################################################</span>
        <span class="c1"># Cluster data, append cluster index to expression DataFrame</span>
        <span class="c1">##############################################################################################</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Calculating clustering of PCA data&#39;</span><span class="p">)</span>
        <span class="n">df_xpca</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_hdf</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">saveDir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataName</span> <span class="o">+</span> <span class="s1">&#39;_processed.h5&#39;</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;df_xpca&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
        <span class="n">sendDfExpr</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">clusteringFunction</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">dict</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">clusteringFunction</span><span class="p">[</span><span class="n">clusterExpression</span><span class="p">]:</span>
                    <span class="n">sendDfExpr</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="n">cellClusterIndexLabel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cluster</span><span class="p">(</span><span class="n">df_xpca</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> 
                                             <span class="n">df_expr</span><span class="o">=</span><span class="n">df_expr</span> <span class="k">if</span> <span class="n">sendDfExpr</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span> 
                                             <span class="n">clusteringFunction</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">clusteringFunction</span><span class="p">)</span>
        <span class="n">df_clusters</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">cellClusterIndexLabel</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">df_expr</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
        <span class="n">df_clusters</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;cluster&#39;</span><span class="p">]</span>
        <span class="n">df_clusters</span><span class="o">.</span><span class="n">to_hdf</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">saveDir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataName</span> <span class="o">+</span> <span class="s1">&#39;_processed.h5&#39;</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;df_clusters&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="n">complevel</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">complib</span><span class="o">=</span><span class="s1">&#39;zlib&#39;</span><span class="p">)</span>
        <span class="n">df_expr</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df_clusters</span><span class="p">,</span> <span class="n">df_expr</span><span class="o">.</span><span class="n">T</span><span class="p">],</span> <span class="n">sort</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s1">&#39;batch&#39;</span><span class="p">,</span> <span class="s1">&#39;cell&#39;</span><span class="p">,</span> <span class="s1">&#39;cluster&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
        <span class="n">timeMark</span><span class="p">()</span>

        <span class="c1">##############################################################################################</span>
        <span class="c1"># Calculate average of each gene in each cluster</span>
        <span class="c1">##############################################################################################</span>
        <span class="n">df_gene_cluster_centroids</span> <span class="o">=</span> <span class="n">df_expr</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;cluster&#39;</span><span class="p">],</span> <span class="n">sort</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">df_gene_cluster_centroids</span><span class="o">.</span><span class="n">to_hdf</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">saveDir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataName</span> <span class="o">+</span> <span class="s1">&#39;_processed.h5&#39;</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;df_gene_cluster_centroids&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="n">complevel</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">complib</span><span class="o">=</span><span class="s1">&#39;zlib&#39;</span><span class="p">)</span>

        <span class="c1">##############################################################################################</span>
        <span class="c1"># Get dictionary to map from markers to cell types. Select genes from the marker list only</span>
        <span class="c1">##############################################################################################</span>
        <span class="n">subtypeToType</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">geneListFileName</span><span class="p">,</span> <span class="n">sheet_name</span><span class="o">=</span><span class="s1">&#39;CellTypesGrouped&#39;</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="s1">&#39;CellType&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()[</span><span class="s1">&#39;CellTypeGrouped&#39;</span><span class="p">]</span>
        <span class="n">df_marker_cell_type</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">geneListFileName</span><span class="p">,</span> <span class="n">sheet_name</span><span class="o">=</span><span class="s1">&#39;MarkerCellType&#39;</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="s1">&#39;Marker&#39;</span><span class="p">)</span>
        <span class="n">df_marker_cell_type</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gnc</span><span class="o">.</span><span class="n">Convert</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">df_marker_cell_type</span><span class="o">.</span><span class="n">index</span><span class="p">),</span> <span class="s1">&#39;alias&#39;</span><span class="p">,</span> <span class="s1">&#39;hugo&#39;</span><span class="p">,</span> <span class="n">returnUnknownString</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">df_marker_cell_type</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="o">.</span><span class="n">from_arrays</span><span class="p">([</span><span class="n">df_marker_cell_type</span><span class="o">.</span><span class="n">columns</span><span class="p">,[</span><span class="n">subtypeToType</span><span class="p">[</span><span class="n">subtype</span><span class="p">]</span> <span class="k">for</span> <span class="n">subtype</span> <span class="ow">in</span> <span class="n">df_marker_cell_type</span><span class="o">.</span><span class="n">columns</span><span class="p">]],</span> <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;CellType&#39;</span><span class="p">,</span><span class="s1">&#39;CellTypeGrouped&#39;</span><span class="p">])</span>
        <span class="n">df_marker_cell_type</span> <span class="o">=</span> <span class="n">df_marker_cell_type</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="s1">&#39;CellTypeGrouped&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_marker_cell_type</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">df_expr</span><span class="o">.</span><span class="n">index</span><span class="p">)]</span>
        <span class="n">df_marker_cell_type</span> <span class="o">=</span> <span class="n">df_marker_cell_type</span><span class="p">[</span><span class="n">df_marker_cell_type</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">df_marker_cell_type</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">minimumNumberOfMarkersPerCelltype</span><span class="p">]]</span>
        <span class="n">df_marker_cell_type</span> <span class="o">=</span> <span class="n">df_marker_cell_type</span><span class="p">[</span><span class="n">df_marker_cell_type</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">df_marker_cell_type</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;Marker&#39;</span>
        <span class="n">df_marker_cell_type</span><span class="o">.</span><span class="n">to_hdf</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">saveDir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataName</span> <span class="o">+</span> <span class="s1">&#39;_processed.h5&#39;</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;df_marker_cell_type&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="n">complevel</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">complib</span><span class="o">=</span><span class="s1">&#39;zlib&#39;</span><span class="p">)</span>
        <span class="n">df_marker_cell_type</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">saveDir</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">geneListFileName</span><span class="p">)))</span>
        <span class="n">df_markers_expr</span> <span class="o">=</span> <span class="n">df_expr</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_expr</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">df_marker_cell_type</span><span class="o">.</span><span class="n">index</span><span class="p">)]</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Selected genes from the marker list. DataFrame shape:&#39;</span><span class="p">,</span> <span class="n">df_markers_expr</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">timeMark</span><span class="p">()</span>
            
        <span class="c1">##############################################################################################</span>
        <span class="c1"># Vote on cell type.  Use the voting scheme described in the paper if</span>
        <span class="c1"># no other scheme is given. Update marker expression with &quot;True&quot; labels and record it</span>
        <span class="c1">##############################################################################################</span>
        <span class="n">votingResults</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vote</span><span class="p">(</span><span class="n">df_markers_expr</span><span class="p">,</span> <span class="n">df_marker_cell_type</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dcsVotingScheme</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">votingResults</span><span class="p">)</span>
        <span class="n">df_markers_expr</span> <span class="o">=</span> <span class="n">df_markers_expr</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">T</span>
        <span class="n">df_markers_expr</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">votingResults</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">df_markers_expr</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;cluster&#39;</span><span class="p">]])</span>
        <span class="n">df_markers_expr</span> <span class="o">=</span> <span class="n">df_markers_expr</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s1">&#39;batch&#39;</span><span class="p">,</span> <span class="s1">&#39;cell&#39;</span><span class="p">,</span> <span class="s1">&#39;cluster&#39;</span><span class="p">,</span> <span class="s1">&#39;label&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">to_numeric</span><span class="p">)</span>
        <span class="n">df_markers_expr</span><span class="o">.</span><span class="n">to_hdf</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">saveDir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataName</span> <span class="o">+</span> <span class="s1">&#39;_processed.h5&#39;</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;df_markers_expr&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="n">complevel</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">complib</span><span class="o">=</span><span class="s1">&#39;zlib&#39;</span><span class="p">)</span>
        <span class="n">timeMark</span><span class="p">()</span>

        <span class="c1">##############################################################################################</span>
        <span class="c1"># Extract new marker genes from the annotation results</span>
        <span class="c1">##############################################################################################</span>
        <span class="n">df_gene_cluster_centroids</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_hdf</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">saveDir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataName</span> <span class="o">+</span> <span class="s1">&#39;_processed.h5&#39;</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;df_gene_cluster_centroids&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
        <span class="n">df_gene_cluster_centroids_merged</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        <span class="n">df_votingResults</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">saveDir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataName</span> <span class="o">+</span> <span class="s1">&#39;_voting.xlsx&#39;</span><span class="p">),</span> <span class="n">sheet_name</span><span class="o">=</span><span class="s1">&#39;z-scores&#39;</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="s1">&#39;cluster&#39;</span><span class="p">)[[</span><span class="s1">&#39;# cells in cluster&#39;</span><span class="p">,</span> <span class="s1">&#39;Predicted cell type&#39;</span><span class="p">]]</span>
        <span class="n">groups</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df_votingResults</span><span class="p">[</span><span class="s1">&#39;# cells in cluster&#39;</span><span class="p">],</span> <span class="n">df_votingResults</span><span class="p">[</span><span class="s1">&#39;Predicted cell type&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; #&#39;</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">sort</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">:</span>
            <span class="n">se_cluster_size</span> <span class="o">=</span> <span class="n">group</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;cluster&#39;</span><span class="p">)[</span><span class="s1">&#39;# cells in cluster&#39;</span><span class="p">]</span>
            <span class="n">se_type</span> <span class="o">=</span> <span class="p">(</span><span class="n">df_gene_cluster_centroids</span><span class="p">[</span><span class="n">se_cluster_size</span><span class="o">.</span><span class="n">index</span><span class="p">]</span> <span class="o">*</span> <span class="n">se_cluster_size</span><span class="o">.</span><span class="n">values</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">se_cluster_size</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="n">se_type</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">group</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">df_gene_cluster_centroids_merged</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df_gene_cluster_centroids_merged</span><span class="p">,</span> <span class="n">se_type</span><span class="p">],</span> <span class="n">sort</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">df_gene_cluster_centroids_merged</span> <span class="o">=</span> <span class="n">df_gene_cluster_centroids_merged</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zScoreOfSeries</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">df_gene_cluster_centroids_merged</span><span class="o">.</span><span class="n">to_hdf</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">saveDir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataName</span> <span class="o">+</span> <span class="s1">&#39;_processed.h5&#39;</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;df_new_marker_genes&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="n">complevel</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">complib</span><span class="o">=</span><span class="s1">&#39;zlib&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extractNewMarkerGenes</span><span class="p">()</span>

        <span class="c1">##############################################################################################</span>
        <span class="c1"># Make all plots to conclude analysis</span>
        <span class="c1">##############################################################################################</span>
        <span class="k">if</span> <span class="n">visualize</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">visualize</span><span class="p">()</span>

        <span class="k">return</span> <span class="kc">None</span></div>


    <span class="c1"># User functions of class ###########################################################################################################################</span>
<div class="viewcode-block" id="DigitalCellSorter.getCountsDataframe"><a class="viewcode-back" href="../../DigitalCellSorterClass.html#DigitalCellSorter.DigitalCellSorter.DigitalCellSorter.getCountsDataframe">[docs]</a>    <span class="k">def</span> <span class="nf">getCountsDataframe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">se1</span><span class="p">,</span> <span class="n">se2</span><span class="p">,</span> <span class="n">tagForMissing</span><span class="o">=</span><span class="s1">&#39;Missing&#39;</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Get a pandas.DataFrame with cross-counts (overlaps) between two pandas.Series</span>

<span class="sd">        Parameters:</span>
<span class="sd">            se1: pandas.Series</span>
<span class="sd">                Series with the first set of items</span>

<span class="sd">            se2: pandas.Series </span>
<span class="sd">                Series with the second set of items</span>

<span class="sd">            tagForMissing: str, Default &#39;Missing&#39;</span>
<span class="sd">                Label to assign to non-overlapping items</span>

<span class="sd">        Returns:</span>
<span class="sd">            pandas.DataFrame</span>
<span class="sd">                Contains counts</span>
<span class="sd">        </span>
<span class="sd">        Usage:</span>
<span class="sd">            DCS = DigitalCellSorter.DigitalCellSorter()</span>

<span class="sd">            df = DCS.getCountsDataframe(se1, se2)</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">def</span> <span class="nf">alignSeries</span><span class="p">(</span><span class="n">se1</span><span class="p">,</span> <span class="n">se2</span><span class="p">,</span> <span class="n">tagForMissing</span><span class="p">):</span>

            <span class="sd">&#39;&#39;&#39;Unit test:</span>
<span class="sd">                se1, se2 = alignSeries(pd.Index([&#39;A&#39;, &#39;B&#39;, &#39;C&#39;, &#39;D&#39;]).to_series(), pd.Index([&#39;B&#39;, &#39;C&#39;, &#39;D&#39;, &#39;E&#39;, &#39;F&#39;]).to_series())</span>
<span class="sd">            &#39;&#39;&#39;</span>

            <span class="n">append</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">se1</span><span class="p">,</span> <span class="n">se2</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">se1</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">se2</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">se1</span><span class="o">.</span><span class="n">index</span><span class="p">),</span> <span class="n">data</span><span class="o">=</span><span class="p">[</span><span class="n">tagForMissing</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">se2</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">se1</span><span class="o">.</span><span class="n">index</span><span class="p">)))],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="n">se1</span> <span class="o">=</span> <span class="n">append</span><span class="p">(</span><span class="n">se1</span><span class="p">,</span> <span class="n">se2</span><span class="p">)</span>
            <span class="n">se2</span> <span class="o">=</span> <span class="n">append</span><span class="p">(</span><span class="n">se2</span><span class="p">,</span> <span class="n">se1</span><span class="p">)</span>

            <span class="n">se1</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;se1&#39;</span>
            <span class="n">se2</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;se2&#39;</span>

            <span class="k">return</span> <span class="n">se1</span><span class="p">,</span> <span class="n">se2</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">se1</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>

        <span class="n">se1</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;index&#39;</span>
        <span class="n">se2</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;index&#39;</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">alignSeries</span><span class="p">(</span><span class="n">se1</span><span class="p">,</span> <span class="n">se2</span><span class="p">,</span> <span class="n">tagForMissing</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">counts</span> <span class="o">=</span> <span class="p">{</span><span class="n">group</span><span class="p">[</span><span class="mi">0</span><span class="p">]:{</span><span class="n">k</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">group</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">&#39;se1&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">groups</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span> <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;index&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;se2&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;se2&#39;</span><span class="p">)}</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">counts</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

        <span class="n">moveTag</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span> <span class="o">!=</span> <span class="n">tagForMissing</span><span class="p">)[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span> <span class="o">==</span> <span class="n">tagForMissing</span><span class="p">)[</span><span class="mi">0</span><span class="p">]]],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="k">if</span> <span class="n">tagForMissing</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span> <span class="k">else</span> <span class="n">df</span>

        <span class="k">return</span> <span class="n">moveTag</span><span class="p">(</span><span class="n">moveTag</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">)</span></div>

<div class="viewcode-block" id="DigitalCellSorter.getAnomalyScores"><a class="viewcode-back" href="../../DigitalCellSorterClass.html#DigitalCellSorter.DigitalCellSorter.DigitalCellSorter.getAnomalyScores">[docs]</a>    <span class="k">def</span> <span class="nf">getAnomalyScores</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trainingSet</span><span class="p">,</span> <span class="n">testingSet</span><span class="p">,</span> <span class="n">printResults</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Function to get anomaly score of cells based on some reference</span>

<span class="sd">        Parameters:</span>
<span class="sd">            trainingSet: pandas.DataFrame</span>
<span class="sd">                With cells to trail isolation forest on</span>

<span class="sd">            testingSet: pandas.DataFrame</span>
<span class="sd">                With cells to score</span>

<span class="sd">            printResults: boolean, Default False</span>
<span class="sd">                Whether to print results</span>

<span class="sd">        Returns:</span>
<span class="sd">            1d numpy.array</span>
<span class="sd">                Anomaly score(s) of tested cell(s)</span>
<span class="sd">        </span>
<span class="sd">        Usage:</span>
<span class="sd">            DCS = DigitalCellSorter.DigitalCellSorter()</span>

<span class="sd">            cutoff = DCS.checkCellsByIsolationForest(df_expr.iloc[:, 5:], df_expr.iloc[:, :5])</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">instanceIsolationForest</span> <span class="o">=</span> <span class="n">IsolationForest</span><span class="p">(</span><span class="n">behaviour</span><span class="o">=</span><span class="s1">&#39;new&#39;</span><span class="p">,</span>
                                                  <span class="n">max_samples</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="n">trainingSet</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">100</span><span class="p">]),</span> 
                                                  <span class="n">random_state</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">RandomState</span><span class="p">(</span><span class="kc">None</span><span class="p">),</span> 
                                                  <span class="n">contamination</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">)</span>

        <span class="n">instanceIsolationForest</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">trainingSet</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">testingSet</span><span class="p">)</span> <span class="ow">is</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
            <span class="n">testingSet</span> <span class="o">=</span> <span class="n">testingSet</span><span class="o">.</span><span class="n">to_frame</span><span class="p">()</span>

        <span class="n">scores</span> <span class="o">=</span> <span class="n">instanceIsolationForest</span><span class="o">.</span><span class="n">score_samples</span><span class="p">(</span><span class="n">testingSet</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>

        <span class="n">scores</span> <span class="o">*=</span> <span class="o">-</span><span class="mf">1.</span>

        <span class="n">results</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">testingSet</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">scores</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">printResults</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Cell:&#39;</span><span class="p">,</span> <span class="n">cell</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;Score:&#39;</span><span class="p">,</span> <span class="n">cell</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">scores</span></div>

<div class="viewcode-block" id="DigitalCellSorter.getExprOfCells"><a class="viewcode-back" href="../../DigitalCellSorterClass.html#DigitalCellSorter.DigitalCellSorter.DigitalCellSorter.getExprOfCells">[docs]</a>    <span class="k">def</span> <span class="nf">getExprOfCells</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cells</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Get expression of a set of cells.</span>
<span class="sd">        Run this function only after function process()</span>

<span class="sd">        Parameters:</span>
<span class="sd">            cells: pandas.MultiIndex</span>
<span class="sd">                Index of cells of interest</span>

<span class="sd">        Returns:</span>
<span class="sd">            pandas.DataFrame</span>
<span class="sd">                With expression of the cells of interest</span>

<span class="sd">        Usage:</span>
<span class="sd">            DCS = DigitalCellSorter.DigitalCellSorter()</span>

<span class="sd">            DCS.process()</span>

<span class="sd">            DCS.getDfExprOfSelectedCells(cells)</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">df_expr</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_hdf</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">saveDir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataName</span> <span class="o">+</span> <span class="s1">&#39;_processed.h5&#39;</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;df_expr&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
        <span class="n">df_expr</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;batch&#39;</span><span class="p">,</span> <span class="s1">&#39;cell&#39;</span><span class="p">,</span> <span class="s1">&#39;gene&#39;</span><span class="p">]</span>
        <span class="n">df_expr</span> <span class="o">=</span> <span class="n">df_expr</span><span class="o">.</span><span class="n">unstack</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="s1">&#39;gene&#39;</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
        <span class="n">df_expr</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">df_expr</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="s1">&#39;gene&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">df_expr</span><span class="p">[</span><span class="n">cells</span><span class="p">]</span></div>

<div class="viewcode-block" id="DigitalCellSorter.getAnomalyScoresPlot"><a class="viewcode-back" href="../../DigitalCellSorterClass.html#DigitalCellSorter.DigitalCellSorter.DigitalCellSorter.getAnomalyScoresPlot">[docs]</a>    <span class="k">def</span> <span class="nf">getAnomalyScoresPlot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cells</span><span class="o">=</span><span class="s1">&#39;All&#39;</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Make anomaly scores plot</span>

<span class="sd">        Parameters:</span>
<span class="sd">            cells: pandas.MultiIndex, Default &#39;All&#39;</span>
<span class="sd">                Index of cells of interest</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>

<span class="sd">        Usage:</span>
<span class="sd">            DCS = DigitalCellSorter.DigitalCellSorter()</span>

<span class="sd">            DCS.process()</span>

<span class="sd">            cells = DCS.getCells(celltype=&#39;T cell&#39;)</span>

<span class="sd">            DCS.makeAnomalyScoresPlot(cells)</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">df_tsne</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_hdf</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">saveDir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataName</span> <span class="o">+</span> <span class="s1">&#39;_processed.h5&#39;</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;df_tsne&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">cells</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">cells</span><span class="o">==</span><span class="s1">&#39;All&#39;</span><span class="p">:</span>
                <span class="n">cells</span> <span class="o">=</span> <span class="n">df_tsne</span><span class="o">.</span><span class="n">columns</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&quot;cells&quot; value &quot;</span><span class="si">%s</span><span class="s1">&quot; is unknown&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">cells</span><span class="p">))</span>
                <span class="k">raise</span> <span class="ne">ValueError</span>

        <span class="n">df_sel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getExprOfCells</span><span class="p">(</span><span class="n">cells</span><span class="p">)</span>
        <span class="n">timeMark</span><span class="p">()</span>

        <span class="n">scores</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getAnomalyScores</span><span class="p">(</span><span class="n">df_sel</span><span class="p">,</span> <span class="n">df_sel</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Loaded expression data&#39;</span><span class="p">)</span>
        <span class="n">timeMark</span><span class="p">()</span>

        <span class="n">scores</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">cells</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">scores</span><span class="p">)</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">df_tsne</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">makeTSNEplot</span><span class="p">(</span><span class="n">df_tsne</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">scores</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">saveDir</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s1">&#39;by_anomaly_score&#39;</span><span class="p">,</span> <span class="n">legend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">colorbar</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">return</span> <span class="kc">None</span></div>
    
<div class="viewcode-block" id="DigitalCellSorter.getIndividualGeneExpressionPlot"><a class="viewcode-back" href="../../DigitalCellSorterClass.html#DigitalCellSorter.DigitalCellSorter.DigitalCellSorter.getIndividualGeneExpressionPlot">[docs]</a>    <span class="k">def</span> <span class="nf">getIndividualGeneExpressionPlot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gene</span><span class="p">,</span> <span class="n">hideClusterLabels</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">outlineClusters</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Produce individual gene expression plot on a tSNE layout</span>

<span class="sd">        Parameters:</span>
<span class="sd">            gene: str</span>
<span class="sd">                Name of gene of interest</span>

<span class="sd">            hideClusterLabels: boolean, Default False</span>
<span class="sd">                Whether to hide the clusters labels</span>

<span class="sd">            outlineClusters: boolean, Default True</span>
<span class="sd">                Whether to outline the clusters with circles</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>
<span class="sd">        </span>
<span class="sd">        Usage:</span>
<span class="sd">            DCS = DigitalCellSorter.DigitalCellSorter()</span>

<span class="sd">            DCS.getIndividualGeneExpressionPlot(&#39;CD4&#39;)</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">df_markers_expr</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_hdf</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">saveDir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataName</span> <span class="o">+</span> <span class="s1">&#39;_processed.h5&#39;</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;df_expr&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">xs</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">gene</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
        <span class="n">df_markers_expr</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="p">[</span><span class="n">gene</span><span class="p">]</span>

        <span class="n">df_tsne</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_hdf</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">saveDir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataName</span> <span class="o">+</span> <span class="s1">&#39;_processed.h5&#39;</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;df_tsne&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
        <span class="n">df_markers_expr</span> <span class="o">=</span> <span class="n">df_markers_expr</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">df_tsne</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mf">0.</span><span class="p">)</span>

        <span class="n">labelled</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_hdf</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">saveDir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataName</span> <span class="o">+</span> <span class="s1">&#39;_processed.h5&#39;</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;df_markers_expr&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">columns</span>
        <span class="n">df_markers_expr</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">labelled</span><span class="o">.</span><span class="n">to_series</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s1">&#39;batch&#39;</span><span class="p">,</span> <span class="s1">&#39;cell&#39;</span><span class="p">])[</span><span class="s1">&#39;cluster&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_markers_expr</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s1">&#39;batch&#39;</span><span class="p">,</span> <span class="s1">&#39;cell&#39;</span><span class="p">,</span> <span class="s1">&#39;cluster&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">index</span>

        <span class="n">hugo_cd_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">gene</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">gnc</span><span class="o">.</span><span class="n">Convert</span><span class="p">([</span><span class="n">gene</span><span class="p">],</span> <span class="s1">&#39;hugo&#39;</span><span class="p">,</span> <span class="s1">&#39;alias&#39;</span><span class="p">,</span> <span class="n">returnUnknownString</span><span class="o">=</span><span class="kc">False</span><span class="p">)[</span><span class="mi">0</span><span class="p">]}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">makeMarkerSubplots</span><span class="p">(</span><span class="n">df_markers_expr</span><span class="p">,</span> <span class="n">df_tsne</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">hugo_cd_dict</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">saveDir</span><span class="p">,</span> <span class="n">NoFrameOnFigures</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">HideClusterLabels</span><span class="o">=</span><span class="n">hideClusterLabels</span><span class="p">,</span> <span class="n">outlineClusters</span><span class="o">=</span><span class="n">outlineClusters</span><span class="p">)</span>

        <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="DigitalCellSorter.getCells"><a class="viewcode-back" href="../../DigitalCellSorterClass.html#DigitalCellSorter.DigitalCellSorter.DigitalCellSorter.getCells">[docs]</a>    <span class="k">def</span> <span class="nf">getCells</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">celltype</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">clusterIndex</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">clusterName</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Get cell annoations in a form of pandas.Series</span>

<span class="sd">        Parameters:</span>
<span class="sd">            celltype: str, Default None</span>
<span class="sd">                Cell type to extract</span>

<span class="sd">            clusterIndex: int, Default None</span>
<span class="sd">                Cell type to extract</span>

<span class="sd">            clusterName: str, Default None</span>
<span class="sd">                Cell type to extract</span>

<span class="sd">        Returns:</span>
<span class="sd">            pandas.MultiIndex</span>
<span class="sd">                Index of labelled cells</span>
<span class="sd">        </span>
<span class="sd">        Usage:</span>
<span class="sd">            DCS = DigitalCellSorter.DigitalCellSorter()</span>

<span class="sd">            DCS.process(df_expr)</span>

<span class="sd">            labels = DCS.getLabelledCells()</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_hdf</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">saveDir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataName</span> <span class="o">+</span> <span class="s1">&#39;_processed.h5&#39;</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;df_markers_expr&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">to_frame</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">clusterIndex</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>

            <span class="n">se</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s1">&#39;batch&#39;</span><span class="p">,</span> <span class="s1">&#39;cell&#39;</span><span class="p">])[</span><span class="s1">&#39;cluster&#39;</span><span class="p">]</span>

            <span class="n">condition</span> <span class="o">=</span> <span class="n">se</span><span class="o">==</span><span class="n">clusterIndex</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">condition</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No cells found&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span>

            <span class="n">selectedCells</span> <span class="o">=</span> <span class="n">se</span><span class="p">[</span><span class="n">condition</span><span class="p">]</span><span class="o">.</span><span class="n">index</span>

            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Selected </span><span class="si">%s</span><span class="s1"> cells from cluster: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">selectedCells</span><span class="p">),</span> <span class="n">clusterIndex</span><span class="p">))</span>

            <span class="k">return</span> <span class="n">selectedCells</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">clusterName</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>

            <span class="n">se</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s1">&#39;batch&#39;</span><span class="p">,</span> <span class="s1">&#39;cell&#39;</span><span class="p">])[</span><span class="s1">&#39;cluster&#39;</span><span class="p">]</span>

            <span class="n">condition</span> <span class="o">=</span> <span class="n">se</span><span class="o">==</span><span class="nb">eval</span><span class="p">(</span><span class="n">clusterName</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">condition</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No cells found&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span>

            <span class="n">selectedCells</span> <span class="o">=</span> <span class="n">se</span><span class="p">[</span><span class="n">condition</span><span class="p">]</span><span class="o">.</span><span class="n">index</span>

            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Selected </span><span class="si">%s</span><span class="s1"> cells from cluster: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">selectedCells</span><span class="p">),</span> <span class="n">clusterName</span><span class="p">))</span>

            <span class="k">return</span> <span class="n">selectedCells</span>

        <span class="n">se</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s1">&#39;batch&#39;</span><span class="p">,</span> <span class="s1">&#39;cell&#39;</span><span class="p">])[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">celltype</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">clusterIndex</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>

            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Available cell types:&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">se</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; #&#39;</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Note: To get a specific cell type call this function with a specified cell type&#39;</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">se</span>

        <span class="n">condition</span> <span class="o">=</span> <span class="n">se</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">celltype</span><span class="p">)</span><span class="o">!=-</span><span class="mi">1</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">condition</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No cells found&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">selectedCells</span> <span class="o">=</span> <span class="n">se</span><span class="p">[</span><span class="n">condition</span><span class="p">]</span><span class="o">.</span><span class="n">index</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Selected </span><span class="si">%s</span><span class="s1"> cells of type: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">selectedCells</span><span class="p">),</span> <span class="n">celltype</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">selectedCells</span></div>

<div class="viewcode-block" id="DigitalCellSorter.getIndexOfGoodQualityCells"><a class="viewcode-back" href="../../DigitalCellSorterClass.html#DigitalCellSorter.DigitalCellSorter.DigitalCellSorter.getIndexOfGoodQualityCells">[docs]</a>    <span class="k">def</span> <span class="nf">getIndexOfGoodQualityCells</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">saveDir</span><span class="p">,</span> <span class="n">dataName</span><span class="p">,</span> <span class="n">count_depth_cutoff</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">number_of_genes_cutoff</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">mitochondrial_genes_cutoff_upper_bound</span><span class="o">=</span><span class="mf">3.0</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Get index of sells that satisfy the QC criteria</span>

<span class="sd">        Parameters:</span>
<span class="sd">            saveDir: str</span>
<span class="sd">                Directory for output files</span>

<span class="sd">            dataName: str </span>
<span class="sd">                Name used in output files</span>

<span class="sd">            count_depth_cutoff: float, Default 0.5</span>
<span class="sd">                Fraction of median to take as count depth cutoff</span>

<span class="sd">            number_of_genes_cutoff: float, Default 0.5</span>
<span class="sd">                Fraction of median to take as number of genes cutoff</span>

<span class="sd">            mitochondrial_genes_cutoff: float, Default 3.0</span>
<span class="sd">                The cutoff is median + standard_deviation * this_parameter</span>

<span class="sd">        Returns:</span>
<span class="sd">            pandas.Index</span>
<span class="sd">                Index of cells</span>
<span class="sd">        </span>
<span class="sd">        Usage:</span>
<span class="sd">            DCS = DigitalCellSorter.DigitalCellSorter()</span>

<span class="sd">            index = DCS.get_index_of_good_quality_cells(saveDir, dataName)</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">df_QC</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_hdf</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">saveDir</span><span class="p">,</span> <span class="n">dataName</span> <span class="o">+</span> <span class="s1">&#39;_processed.h5&#39;</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;QC&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>

        <span class="n">plotsDir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">saveDir</span><span class="p">,</span> <span class="s1">&#39;QC_plots&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">plotsDir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">plotsDir</span><span class="p">)</span>

        <span class="c1"># Calculate cutoffs</span>
        <span class="n">cutoff_count_depth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getQualityControlCutoff</span><span class="p">(</span><span class="n">df_QC</span><span class="p">[</span><span class="s1">&#39;count_depth&#39;</span><span class="p">],</span> <span class="n">count_depth_cutoff</span><span class="p">,</span> <span class="n">plotPathAndName</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">plotsDir</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_count_depth&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">dataName</span><span class="p">)),</span> <span class="n">MakeHistogramPlot</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">cutoff_number_of_genes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getQualityControlCutoff</span><span class="p">(</span><span class="n">df_QC</span><span class="p">[</span><span class="s1">&#39;number_of_genes&#39;</span><span class="p">],</span> <span class="n">number_of_genes_cutoff</span><span class="p">,</span> <span class="n">plotPathAndName</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">plotsDir</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_number_of_genes&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">dataName</span><span class="p">)),</span> <span class="n">MakeHistogramPlot</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">cutoff_fraction_of_mitochondrialGenes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getQualityControlCutoff</span><span class="p">(</span><span class="n">df_QC</span><span class="p">[</span><span class="s1">&#39;fraction_of_mitochondrialGenes&#39;</span><span class="p">],</span> <span class="n">mitochondrial_genes_cutoff_upper_bound</span><span class="p">,</span> <span class="n">plotPathAndName</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">plotsDir</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_fraction_of_mitochondrialGenes&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">dataName</span><span class="p">)),</span> <span class="n">mito</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">MakeHistogramPlot</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">df_QC</span><span class="p">[</span><span class="s1">&#39;isGoodQuality&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df_QC</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>

        <span class="n">df_QC</span><span class="p">[</span><span class="s1">&#39;isGoodQuality&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">df_QC</span><span class="p">[</span><span class="s1">&#39;count_depth&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">cutoff_count_depth</span><span class="p">)</span> <span class="o">&amp;</span> \
            <span class="p">(</span><span class="n">df_QC</span><span class="p">[</span><span class="s1">&#39;number_of_genes&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">cutoff_number_of_genes</span><span class="p">)</span> <span class="o">&amp;</span> \
            <span class="p">(</span><span class="n">df_QC</span><span class="p">[</span><span class="s1">&#39;fraction_of_mitochondrialGenes&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">cutoff_fraction_of_mitochondrialGenes</span><span class="p">)]</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">return</span> <span class="n">df_QC</span><span class="p">[</span><span class="s1">&#39;isGoodQuality&#39;</span><span class="p">][</span><span class="n">df_QC</span><span class="p">[</span><span class="s1">&#39;isGoodQuality&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">sort_values</span><span class="p">()</span></div>

<div class="viewcode-block" id="DigitalCellSorter.getQualityControlCutoff"><a class="viewcode-back" href="../../DigitalCellSorterClass.html#DigitalCellSorter.DigitalCellSorter.DigitalCellSorter.getQualityControlCutoff">[docs]</a>    <span class="k">def</span> <span class="nf">getQualityControlCutoff</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">se</span><span class="p">,</span> <span class="n">cutoff</span><span class="p">,</span> <span class="n">mito</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">plotPathAndName</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">MakeHistogramPlot</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Function to calculate QC quality cutoff</span>

<span class="sd">        Parameters:</span>
<span class="sd">            se: pandas.Series </span>
<span class="sd">                With data to analyze</span>

<span class="sd">            cutoff: float</span>
<span class="sd">                Parameter for calculating the quality control cutoff</span>

<span class="sd">            mito: boolean, Default False</span>
<span class="sd">                Whether the analysis of mitochondrial genes fraction</span>

<span class="sd">            plotPathAndName: str, Default None</span>
<span class="sd">                Text to include in the figure title and file name</span>

<span class="sd">            MakeHistogramPlot: boolean, Default True</span>
<span class="sd">                Whether to make a histogram plot</span>

<span class="sd">        Returns:</span>
<span class="sd">            float</span>
<span class="sd">                Cutoff value</span>
<span class="sd">        </span>
<span class="sd">        Usage:</span>
<span class="sd">            DCS = DigitalCellSorter.DigitalCellSorter()</span>

<span class="sd">            cutoff = DCS.getCutoff(se)</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">subset</span> <span class="o">=</span> <span class="n">se</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">se</span><span class="o">.</span><span class="n">values</span><span class="p">)]</span><span class="o">.</span><span class="n">values</span>

        <span class="k">if</span> <span class="n">mito</span><span class="p">:</span>
            <span class="n">median</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">subset</span><span class="p">),</span><span class="mi">4</span><span class="p">)</span>
            <span class="n">std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">subset</span><span class="p">),</span><span class="mi">4</span><span class="p">)</span>

            <span class="n">hist_of_subset</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">rv_histogram</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">subset</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">)))</span>
            <span class="n">hist_data</span> <span class="o">=</span> <span class="n">hist_of_subset</span><span class="o">.</span><span class="n">_hpdf</span> <span class="o">/</span> <span class="mi">100</span>
            <span class="n">hist_bins</span> <span class="o">=</span> <span class="n">hist_of_subset</span><span class="o">.</span><span class="n">_hbins</span>

            <span class="n">xs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">hist_bins</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">hist_bins</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1000</span><span class="p">)</span>
            <span class="n">spline_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">xs</span><span class="p">,</span> <span class="n">UnivariateSpline</span><span class="p">(</span><span class="n">hist_bins</span><span class="p">,</span> <span class="n">hist_data</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">k</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">0</span><span class="p">)(</span><span class="n">xs</span><span class="p">)))</span><span class="o">.</span><span class="n">T</span>
            <span class="n">smoothed</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">signal</span><span class="o">.</span><span class="n">savgol_filter</span><span class="p">(</span><span class="n">spline_data</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">101</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

            <span class="n">x1</span> <span class="o">=</span> <span class="n">spline_data</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">spline_data</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&gt;</span><span class="n">median</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span>
            <span class="n">y1</span> <span class="o">=</span> <span class="n">smoothed</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">spline_data</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&gt;</span><span class="n">median</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span>

            <span class="n">x2</span> <span class="o">=</span> <span class="n">spline_data</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">spline_data</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&gt;</span><span class="p">(</span><span class="n">median</span><span class="o">+</span><span class="mf">1.5</span><span class="o">*</span><span class="n">std</span><span class="p">))[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span>
            <span class="n">y2</span> <span class="o">=</span> <span class="n">smoothed</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">spline_data</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&gt;</span><span class="p">(</span><span class="n">median</span><span class="o">+</span><span class="mf">1.5</span><span class="o">*</span><span class="n">std</span><span class="p">))[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span>

            <span class="n">cutoff</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">median</span> <span class="o">+</span> <span class="n">cutoff</span> <span class="o">*</span> <span class="n">std</span><span class="p">,</span> <span class="n">x1</span> <span class="o">-</span> <span class="n">y1</span> <span class="o">*</span> <span class="p">(</span><span class="n">x2</span><span class="o">-</span><span class="n">x1</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">y2</span><span class="o">-</span><span class="n">y1</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cutoff</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cutoff</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">subset</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">MakeHistogramPlot</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">makeQualityControlHistogramPlot</span><span class="p">(</span><span class="n">subset</span><span class="p">,</span> <span class="n">cutoff</span><span class="p">,</span> <span class="n">plotPathAndName</span><span class="o">=</span><span class="n">plotPathAndName</span><span class="p">,</span> <span class="n">mito</span><span class="o">=</span><span class="n">mito</span><span class="p">)</span>
            
        <span class="k">return</span> <span class="n">cutoff</span></div>

    
    <span class="c1"># Supporting functions of class ###########################################################################################################################</span>
<div class="viewcode-block" id="DigitalCellSorter.convertColormap"><a class="viewcode-back" href="../../DigitalCellSorterClass.html#DigitalCellSorter.DigitalCellSorter.DigitalCellSorter.convertColormap">[docs]</a>    <span class="k">def</span> <span class="nf">convertColormap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">colormap</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Convert colormap from the form (1.,1.,1.,1.) to &#39;rgba(255,255,255,1.)&#39;</span>

<span class="sd">        Parameters:</span>
<span class="sd">            colormap: dictionary</span>
<span class="sd">                Colormap to convert</span>

<span class="sd">        Returns:</span>
<span class="sd">            dictionary</span>
<span class="sd">                Converted colomap</span>
<span class="sd">        </span>
<span class="sd">        Usage:</span>
<span class="sd">            DCS = DigitalCellSorter.DigitalCellSorter()</span>

<span class="sd">            colormap = DCS.convertColormap(colormap)</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">return</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span><span class="s1">&#39;rgba&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="nb">list</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">v</span><span class="p">[:</span><span class="mi">3</span><span class="p">])</span> <span class="o">*</span> <span class="mi">255</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">))</span> <span class="o">+</span> <span class="p">[</span><span class="n">v</span><span class="p">[</span><span class="mi">3</span><span class="p">]]))</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">colormap</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span></div>

<div class="viewcode-block" id="DigitalCellSorter.zScoreOfSeries"><a class="viewcode-back" href="../../DigitalCellSorterClass.html#DigitalCellSorter.DigitalCellSorter.DigitalCellSorter.zScoreOfSeries">[docs]</a>    <span class="k">def</span> <span class="nf">zScoreOfSeries</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">se</span><span class="p">):</span>
    
        <span class="sd">&#39;&#39;&#39;Calculate z-score of pandas.Series and modify the Series in place</span>
<span class="sd">    </span>
<span class="sd">        Parameters:</span>
<span class="sd">            se: pandas.Series</span>
<span class="sd">                Series to process</span>

<span class="sd">        Returns:</span>
<span class="sd">            pandas.Series</span>
<span class="sd">                Processed series</span>

<span class="sd">        Usage:</span>
<span class="sd">            se = zScoreOfSeries(se)</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">se</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">zscore</span><span class="p">(</span><span class="n">se</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">se</span></div>
        
<div class="viewcode-block" id="DigitalCellSorter.getV"><a class="viewcode-back" href="../../DigitalCellSorterClass.html#DigitalCellSorter.DigitalCellSorter.DigitalCellSorter.getV">[docs]</a>    <span class="k">def</span> <span class="nf">getV</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Calculate the vting scores (celltypes by clusters)</span>
<span class="sd">    </span>
<span class="sd">        Parameters:</span>
<span class="sd">            args: tuple</span>
<span class="sd">                Tuple of sub-arguments</span>

<span class="sd">                df_M: pandas.DataFrame</span>
<span class="sd">                    Marker cell type DataFrame</span>

<span class="sd">                df_markers_expr: pandas.DataFrame</span>
<span class="sd">                    Markers expression DataFrame</span>

<span class="sd">                cluster_index: 1d numpy.array</span>
<span class="sd">                    Clustering index</span>

<span class="sd">                zscore_cutoff: float</span>
<span class="sd">                    Z-Score cutoff for a given marker to be significant</span>

<span class="sd">        Returns:</span>
<span class="sd">            pandas.DataFrame </span>
<span class="sd">                Contains voting scores per celltype per cluster </span>

<span class="sd">        Usage:</span>
<span class="sd">            df = getV((df_marker_celltype, df_markers_expr, cluster_index, 0.3))</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">df_M</span><span class="p">,</span> <span class="n">df_markers_expr</span><span class="p">,</span> <span class="n">cluster_index</span><span class="p">,</span> <span class="n">zscore_cutoff</span> <span class="o">=</span> <span class="n">args</span>

        <span class="n">df_expr_cluster_centroids</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">df_markers_expr</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">df_markers_expr</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">cluster_index</span><span class="p">)</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
            
        <span class="n">df_Z</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">scipy</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">zscore</span><span class="p">(</span><span class="n">df_expr_cluster_centroids</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="n">df_expr_cluster_centroids</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">df_expr_cluster_centroids</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>

        <span class="n">where_significant</span> <span class="o">=</span> <span class="n">df_Z</span> <span class="o">&gt;</span> <span class="n">zscore_cutoff</span>
        <span class="n">df_Z</span><span class="p">[</span><span class="n">where_significant</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="n">df_Z</span><span class="p">[</span><span class="o">~</span><span class="n">where_significant</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="n">df_V</span> <span class="o">=</span> <span class="n">df_M</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">df_Z</span><span class="p">)</span><span class="o">.</span><span class="n">stack</span><span class="p">()</span>

        <span class="n">df_V</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">df_V</span><span class="p">)]</span> <span class="o">=</span> <span class="mf">0.</span>

        <span class="k">return</span> <span class="n">df_V</span></div></div>

</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, S. Domanskyi , A. Szedlak, N. T. Hawkins, J. Wang, G. Paternostro, C. Piermarocchi

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>